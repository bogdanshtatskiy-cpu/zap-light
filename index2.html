<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–ü–í –ó–∞–ø–æ—Ä—ñ–∂–∂—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;800&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script src="quotes.js"></script> 
    <script src="changelog.js"></script>

    <style>
        :root {
            /* –ñ–∏–≤—ã–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ–Ω–∞ */
            --bg-gradient: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            
            --text: #1d1d1f;
            --text-secondary: rgba(60, 60, 67, 0.6);
            
            --accent: #007AFF; /* iOS Blue */
            --on: #34c759;     /* iOS Green */
            --off: #ff3b30;    /* iOS Red */
            
            --modal-overlay: rgba(0, 0, 0, 0.3);
            --blur-strength: 20px;
        }

        body.dark-mode {
            /* –ù–æ—á–Ω–æ–π –∑–∏–º–Ω–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            --bg-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --glass-bg: rgba(30, 30, 30, 0.60);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            
            --text: #f5f5f7;
            --text-secondary: rgba(235, 235, 245, 0.6);
            
            --accent: #0a84ff;
            --on: #32d74b;
            --off: #ff453a;
            --modal-overlay: rgba(0, 0, 0, 0.6);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg-gradient);
            background-attachment: fixed; /* –ß—Ç–æ–±—ã —Ñ–æ–Ω –Ω–µ —Å–∫—Ä–æ–ª–ª–∏–ª—Å—è */
            color: var(--text);
            font-family: 'SF Pro Display', 'Nunito', sans-serif; /* –®—Ä–∏—Ñ—Ç –∫–∞–∫ –≤ iOS */
            margin: 0; padding: 20px 16px;
            min-height: 100vh;
            user-select: none;
            transition: color 0.3s;
            overflow-x: hidden;
        }

        /* --- –°–ù–ï–ì --- */
        #snow-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
            overflow: hidden;
        }
        .snowflake {
            position: absolute; top: -10px;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: fall linear infinite;
        }
        @keyframes fall {
            to { transform: translateY(110vh); }
        }

        /* --- –û–ë–©–ò–ï –°–¢–ò–õ–ò –°–¢–ï–ö–õ–ê --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-strength));
            -webkit-backdrop-filter: blur(var(--blur-strength));
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 24px;
            position: relative;
            z-index: 1;
            transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* HEADER */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; position: relative; z-index: 2; 
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        
        .app-title { 
            font-size: 28px; font-weight: 800; margin: 0; 
            background: linear-gradient(90deg, var(--text) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }
        
        .info-btn { 
            width: 36px; height: 36px; 
            border-radius: 50%; 
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 16px; color: var(--accent);
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .lang-switch { 
            background: rgba(0,0,0,0.05); 
            border-radius: 20px; padding: 4px; display: flex; 
            backdrop-filter: blur(10px);
        }
        .lang-btn { 
            padding: 6px 14px; font-size: 13px; font-weight: 700; 
            border-radius: 16px; opacity: 0.6; cursor: pointer; transition: 0.3s; 
            color: var(--text);
        }
        .lang-btn.active { 
            background: var(--card); /* –ë–µ–ª—ã–π/–¢–µ–º–Ω—ã–π —Ñ–æ–Ω –∫–Ω–æ–ø–∫–∏ */
            background: var(--glass-bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            opacity: 1; color: var(--accent);
        }

        /* DATE TABS */
        .date-container { 
            display: flex; gap: 10px; margin-bottom: 25px; 
            overflow-x: auto; padding-bottom: 5px; 
            -ms-overflow-style: none; scrollbar-width: none; 
            justify-content: flex-start; /* –î–ª—è —Å–∫—Ä–æ–ª–ª–∞ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
        }
        .date-container::-webkit-scrollbar { display: none; }

        .date-tab { 
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 12px 18px; border-radius: 18px; 
            font-size: 14px; font-weight: 700; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            min-width: 100px; text-align: center;
            backdrop-filter: blur(15px);
            color: var(--text-secondary);
        }
        .date-tab.active { 
            background: var(--accent); 
            border-color: var(--accent);
            color: white; 
            transform: scale(1.05);
            box-shadow: 0 8px 20px -5px var(--accent);
        }

        /* QUEUES */
        .queue-grid { 
            display: grid; grid-template-columns: repeat(6, 1fr); 
            gap: 8px; margin-bottom: 30px; 
            position: relative; z-index: 1;
        }
        .queue-btn { 
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 14px 0; border-radius: 16px; 
            font-weight: 700; font-size: 15px; 
            transition: 0.3s; text-align: center; cursor: pointer; 
            backdrop-filter: blur(10px);
            color: var(--text);
        }
        .queue-btn.active { 
            background: var(--text); 
            color: var(--bg-gradient); /* –ò–Ω–≤–µ—Ä—Å–∏—è –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
            color: #fff;
            border-color: var(--text); 
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        /* HERO STATUS (Main Card) */
        .hero { 
            padding: 30px 20px; text-align: center; margin-bottom: 25px; 
            overflow: hidden;
        }
        /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–≤–µ—á–µ–Ω–∏—è —Å–∑–∞–¥–∏ */
        .hero::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            opacity: 0.5; pointer-events: none;
        }

        .icon { 
            font-size: 64px; margin-bottom: 10px; display: block; 
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.4));
            animation: float 4s infinite ease-in-out;
        }
        
        .status-main { font-size: 28px; font-weight: 900; margin-bottom: 8px; letter-spacing: 0.5px; }
        
        .timer { 
            font-size: 20px; font-weight: 700; 
            color: var(--accent); 
            background: rgba(120, 120, 128, 0.1); /* iOS gray fill */
            padding: 8px 16px; border-radius: 12px;
            display: inline-block;
            margin-bottom: 15px;
        }
        .timer-note { font-size: 13px; font-weight: 600; opacity: 0.8; display: block; margin-top: 4px; color: var(--text); }
        
        .quote-box { 
            margin-top: 15px; padding-top: 15px; 
            border-top: 1px solid var(--glass-border); 
            font-size: 15px; font-style: italic; opacity: 0.9; 
            line-height: 1.5; font-weight: 500; min-height: 40px; 
            display: flex; align-items: center; justify-content: center;
        }
        .last-update { font-size: 11px; margin-top: 15px; opacity: 0.5; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        /* VISUAL BAR (LIQUID STYLE) */
        .bar-wrap { position: relative; height: 50px; margin-bottom: 30px; z-index: 1;}
        .bar { 
            display: flex; height: 100%; border-radius: 16px; overflow: hidden; 
            border: 1px solid var(--glass-border); 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
        }
        .chunk { flex: 1; height: 100%; position: relative; }
        /* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –¥–ª—è —á–∞–Ω–∫–æ–≤ */
        .chunk.on { background: linear-gradient(180deg, rgba(52, 199, 89, 0.8) 0%, rgba(52, 199, 89, 0.6) 100%); }
        .chunk.off { background: linear-gradient(180deg, rgba(255, 59, 48, 0.8) 0%, rgba(255, 59, 48, 0.6) 100%); }
        
        /* –ú–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ */
        .marker { 
            position: absolute; top: -6px; bottom: -6px; width: 4px; 
            background: #fff; 
            border-radius: 4px; z-index: 5; transition: left 1s linear; 
            box-shadow: 0 0 15px 2px rgba(255,255,255,0.8);
        }
        .labels { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; opacity: 0.7; margin-top: 8px; padding: 0 5px; }

        /* STATS */
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; z-index: 1; position: relative;}
        .stat-card { 
            padding: 16px; text-align: center; 
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            backdrop-filter: blur(20px);
        }
        .stat-label { font-size: 12px; font-weight: 700; text-transform: uppercase; opacity: 0.6; display: block; margin-bottom: 6px; }
        .stat-val { font-size: 24px; font-weight: 800; }
        .stat-val.on { color: var(--on); text-shadow: 0 0 20px rgba(52, 199, 89, 0.3); }
        .stat-val.off { color: var(--off); text-shadow: 0 0 20px rgba(255, 59, 48, 0.3); }

        /* DETAILED LIST */
        .list-card { 
            padding: 0; overflow: hidden; margin-bottom: 40px; 
        }
        .list-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 16px 20px; border-bottom: 1px solid var(--glass-border); 
            transition: background 0.2s;
        }
        .list-row:last-child { border-bottom: none; }
        .list-row:hover { background: rgba(255,255,255,0.05); }
        
        .row-time { font-size: 17px; font-weight: 700; font-variant-numeric: tabular-nums; letter-spacing: -0.5px; }
        .row-badge { 
            font-size: 14px; font-weight: 700; padding: 6px 14px; border-radius: 12px; 
            display: flex; align-items: center; gap: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .badge-on { background: rgba(52, 199, 89, 0.15); color: var(--on); border: 1px solid rgba(52, 199, 89, 0.2); }
        .badge-off { background: rgba(255, 59, 48, 0.15); color: var(--off); border: 1px solid rgba(255, 59, 48, 0.2); }

        /* MODAL */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--modal-overlay); z-index: 1000; 
            align-items: center; justify-content: center; 
            backdrop-filter: blur(10px); 
            opacity: 0; transition: opacity 0.3s;
        }
        .modal.show { opacity: 1; }
        
        .modal-content { 
            background: var(--glass-bg); width: 90%; max-width: 400px; max-height: 80vh; 
            border-radius: 32px; padding: 30px; position: relative; 
            display: flex; flex-direction: column; 
            border: 1px solid var(--glass-border); 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal.show .modal-content { transform: scale(1); }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-title { font-size: 24px; font-weight: 800; }
        .close-btn { font-size: 28px; cursor: pointer; opacity: 0.6; padding: 5px; transition: 0.2s; }
        .close-btn:hover { opacity: 1; transform: rotate(90deg); }

        .dev-info { text-align: center; margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid var(--glass-border); }
        .dev-link { 
            display: inline-block; background: var(--accent); color: white; 
            text-decoration: none; padding: 12px 24px; border-radius: 16px; 
            font-weight: 700; font-size: 15px; margin-top: 15px; 
            box-shadow: 0 5px 15px rgba(0, 122, 255, 0.4);
            transition: 0.2s;
        }
        .dev-link:hover { transform: scale(1.05); }

        .loader { text-align: center; padding: 50px; font-weight: 800; opacity: 0.6; font-size: 18px; }
        @keyframes float { 0%, 100% {transform:translateY(0)} 50% {transform:translateY(-10px)} }
    </style>
</head>
<body>
    
    <div id="snow-container"></div>

    <div class="header">
        <div class="header-left">
            <div class="info-btn" onclick="openInfo()">i</div>
            <div class="app-title" id="app-title">‚ö° –ì–ü–í</div>
        </div>
        <div class="lang-switch">
            <div class="lang-btn active" id="btn-uk" onclick="setLang('uk')">UA</div>
            <div class="lang-btn" id="btn-ru" onclick="setLang('ru')">RU</div>
        </div>
    </div>

    <div class="date-container" id="dates"></div>
    <div class="queue-grid" id="queues"></div>

    <div class="hero glass-panel" id="hero" style="display:none">
        <span class="icon" id="icon">‚ö°</span>
        <div class="status-main" id="status">...</div>
        <div class="timer" id="timer">...</div>
        <div class="quote-box" id="quote"></div>
        <div class="last-update" id="updated"></div>
    </div>

    <div class="bar-wrap" id="bar-wrap" style="display:none">
        <div class="bar" id="visual"></div>
        <div class="marker" id="marker"></div>
        <div class="labels"><span>00</span><span>06</span><span>12</span><span>18</span><span>24</span></div>
    </div>

    <div class="stats" id="stats" style="display:none">
        <div class="stat-card">
            <span class="stat-label" id="lbl-on">–°–≤—ñ—Ç–ª–æ —î</span>
            <div class="stat-val on" id="val-on">-</div>
        </div>
        <div class="stat-card">
            <span class="stat-label" id="lbl-off">–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞</span>
            <div class="stat-val off" id="val-off">-</div>
        </div>
    </div>

    <div class="list-card glass-panel" id="details-list" style="display:none"></div>
    <div class="loader" id="loader">...</div>

    <div id="info-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</div>
                <div class="close-btn" onclick="closeInfo()">√ó</div>
            </div>
            <div class="dev-info">
                <div style="font-size:14px; opacity:0.7; margin-bottom:5px;" id="dev-label">–†–æ–∑—Ä–æ–±–Ω–∏–∫</div>
                <div style="font-weight:800; font-size:22px; background: linear-gradient(90deg, #00C9FF 0%, #92FE9D 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">DesOope</div>
                <a href="https://t.me/desoope" target="_blank" class="dev-link">Telegram</a>
            </div>
            <div style="font-size:12px; font-weight:800; opacity:0.4; margin-bottom:15px; text-transform:uppercase; letter-spacing: 1px;" id="cl-label">–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω</div>
            <div class="changelog-list" id="changelog-container"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- SNOW GENERATOR ---
        function createSnow() {
            const container = document.getElementById('snow-container');
            const count = 30; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–Ω–µ–∂–∏–Ω–æ–∫
            for (let i = 0; i < count; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                // –†–∞–Ω–¥–æ–º–Ω—ã–π —Ä–∞–∑–º–µ—Ä
                const size = Math.random() * 5 + 2; 
                flake.style.width = size + 'px';
                flake.style.height = size + 'px';
                // –†–∞–Ω–¥–æ–º–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
                flake.style.left = Math.random() * 100 + 'vw';
                // –†–∞–Ω–¥–æ–º–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                flake.style.animationDuration = Math.random() * 5 + 5 + 's';
                flake.style.animationDelay = Math.random() * 5 + 's';
                flake.style.opacity = Math.random() * 0.5 + 0.3;
                
                container.appendChild(flake);
            }
        }

        const UA_MONTHS = ["–°–Ü–ß–ù–Ø", "–õ–Æ–¢–û–ì–û", "–ë–ï–†–ï–ó–ù–Ø", "–ö–í–Ü–¢–ù–Ø", "–¢–†–ê–í–ù–Ø", "–ß–ï–†–í–ù–Ø", "–õ–ò–ü–ù–Ø", "–°–ï–†–ü–ù–Ø", "–í–ï–†–ï–°–ù–Ø", "–ñ–û–í–¢–ù–Ø", "–õ–ò–°–¢–û–ü–ê–î–ê", "–ì–†–£–î–ù–Ø"];
        const RU_MONTHS = ["–Ø–ù–í–ê–†–Ø", "–§–ï–í–†–ê–õ–Ø", "–ú–ê–†–¢–ê", "–ê–ü–†–ï–õ–Ø", "–ú–ê–Ø", "–ò–Æ–ù–Ø", "–ò–Æ–õ–Ø", "–ê–í–ì–£–°–¢–ê", "–°–ï–ù–¢–Ø–ë–†–Ø", "–û–ö–¢–Ø–ë–†–Ø", "–ù–û–Ø–ë–†–Ø", "–î–ï–ö–ê–ë–†–Ø"];
        
        let DATA = [];
        let todaySchedule = null;
        let viewSchedule = null;
        
        let selectedQueue = localStorage.getItem('queue');
        let lang = localStorage.getItem('lang') || 'uk';
        let lastStatusType = null; 

        const T = {
            uk: { 
                title: "‚ö° –ì–ü–í",
                load: "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...", nodata: "–î–∞–Ω–∏—Ö –Ω–µ–º–∞—î", choose: "–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É", 
                on: "–°–í–Ü–¢–õ–û –Ñ", off: "–°–í–Ü–¢–õ–ê –ù–ï–ú–ê", 
                in_on: "–í–≤—ñ–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑:", in_off: "–í–∏–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑:", 
                upd: "–ê–∫—Ç—É–∞–ª—å–Ω–æ –Ω–∞:", h: "–≥–æ–¥", m: "—Ö–≤", 
                lbl_on: "–°–≤—ñ—Ç–ª–æ —î", lbl_off: "–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞",
                tom: "–∑–∞–≤—Ç—Ä–∞", at: "–æ",
                modal_title: "–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è", dev: "–†–æ–∑—Ä–æ–±–Ω–∏–∫", cl: "–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω"
            },
            ru: { 
                title: "‚ö° –ì–ü–û",
                load: "–ó–∞–≥—Ä—É–∑–∫–∞...", nodata: "–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç", choose: "–í—ã–±–µ—Ä–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å", 
                on: "–°–í–ï–¢ –ï–°–¢–¨", off: "–°–í–ï–¢–ê –ù–ï–¢", 
                in_on: "–í–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑:", in_off: "–û—Ç–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑:", 
                upd: "–ê–∫—Ç—É–∞–ª—å–Ω–æ –Ω–∞:", h: "—á", m: "–º–∏–Ω", 
                lbl_on: "–°–≤–µ—Ç –µ—Å—Ç—å", lbl_off: "–°–≤–µ—Ç–∞ –Ω–µ—Ç",
                tom: "–∑–∞–≤—Ç—Ä–∞", at: "–≤",
                modal_title: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", dev: "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫", cl: "–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π"
            }
        };

        // --- INIT ---
        async function init() {
            createSnow(); // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–Ω–µ–≥
            setLang(lang);
            document.getElementById('loader').innerText = T[lang].load;

            try {
                const res = await fetch('schedule.json?v=' + Date.now());
                const json = await res.json();
                DATA = json.schedules;

                if (!DATA || DATA.length === 0) {
                    document.getElementById('loader').innerText = T[lang].nodata;
                    return;
                }

                document.getElementById('loader').style.display = 'none';
                renderQueues();
                
                const kievDate = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Kiev"}));
                const todayDay = kievDate.getDate();
                const todayMonthIdx = kievDate.getMonth();

                let todayIdx = -1;
                DATA.forEach((item, idx) => {
                    const parts = item.date.split(' ');
                    const d = parseInt(parts[0]);
                    const mName = parts[1].toUpperCase();
                    const mIdx = UA_MONTHS.indexOf(mName);
                    if (d === todayDay && mIdx === todayMonthIdx) todayIdx = idx;
                });

                const fallbackIdx = DATA.length - 1;
                const activeIdx = todayIdx !== -1 ? todayIdx : fallbackIdx;

                todaySchedule = DATA[activeIdx]; 
                
                renderDates(activeIdx);
                selectDate(activeIdx);

                if (selectedQueue) selectQueue(selectedQueue);
                else {
                    document.getElementById('hero').style.display = 'block';
                    document.getElementById('status').innerText = T[lang].choose;
                }

                setInterval(tick, 1000);

            } catch (e) {
                console.error(e);
                document.getElementById('loader').innerText = "Error loading data";
            }
        }

        // --- RENDER ---
        function renderDates(activeIdx) {
            const el = document.getElementById('dates');
            el.innerHTML = '';
            DATA.forEach((item, idx) => {
                const btn = document.createElement('div');
                btn.className = `date-tab ${idx === activeIdx ? 'active' : ''}`;
                let label = item.date;
                if (lang === 'ru') {
                    const parts = item.date.split(' ');
                    const mIdx = UA_MONTHS.indexOf(parts[1].toUpperCase());
                    if (mIdx !== -1) label = `${parts[0]} ${RU_MONTHS[mIdx]}`;
                }
                btn.innerText = label;
                btn.onclick = () => { selectDate(idx); renderDates(idx); };
                el.appendChild(btn);
            });
        }

        function renderQueues() {
            const el = document.getElementById('queues');
            const qs = ["1.1", "1.2", "2.1", "2.2", "3.1", "3.2", "4.1", "4.2", "5.1", "5.2", "6.1", "6.2"];
            el.innerHTML = '';
            qs.forEach(q => {
                const btn = document.createElement('div');
                btn.className = `queue-btn ${q === selectedQueue ? 'active' : ''}`;
                btn.innerText = q;
                btn.onclick = () => selectQueue(q);
                el.appendChild(btn);
            });
        }

        function selectDate(idx) {
            viewSchedule = DATA[idx]; 
            if (selectedQueue) {
                updateView();
            }
        }

        function selectQueue(q) {
            selectedQueue = q;
            localStorage.setItem('queue', q);
            document.querySelectorAll('.queue-btn').forEach(b => {
                b.classList.toggle('active', b.innerText === q);
            });
            document.getElementById('hero').style.display = 'block';
            document.getElementById('bar-wrap').style.display = 'block';
            document.getElementById('stats').style.display = 'grid';
            document.getElementById('details-list').style.display = 'block';
            
            lastStatusType = null;
            
            tick();
            updateView();
        }

        function setLang(l) {
            lang = l;
            localStorage.setItem('lang', l);
            
            document.getElementById('btn-uk').className = `lang-btn ${l==='uk'?'active':''}`;
            document.getElementById('btn-ru').className = `lang-btn ${l==='ru'?'active':''}`;
            
            document.getElementById('app-title').innerText = T[l].title;
            document.getElementById('lbl-on').innerText = T[l].lbl_on;
            document.getElementById('lbl-off').innerText = T[l].lbl_off;
            
            document.getElementById('modal-title').innerText = T[l].modal_title;
            document.getElementById('dev-label').innerText = T[l].dev;
            document.getElementById('cl-label').innerText = T[l].cl;
            
            if(DATA.length) {
                const idx = DATA.indexOf(viewSchedule);
                renderDates(idx !== -1 ? idx : 0);
                if (!selectedQueue) document.getElementById('status').innerText = T[l].choose;
                else {
                    updateView();
                    tick();
                }
            }
            renderChangelog();
        }

        function updateView() {
            if (!viewSchedule || !selectedQueue) return;

            const timeline = document.getElementById('visual');
            const listEl = document.getElementById('details-list');
            timeline.innerHTML = '';
            listEl.innerHTML = '';
            
            const map = getDayMap(viewSchedule, selectedQueue);
            let offMins = 0;
            let current = map[0];
            let start = 0;

            for(let i=1; i<=1440; i++) {
                if(i===1440 || map[i] !== current) {
                    const d = document.createElement('div');
                    d.className = `chunk ${current ? 'on' : 'off'}`;
                    d.style.flexBasis = ((i-start)/1440*100) + '%';
                    timeline.appendChild(d);

                    const row = document.createElement('div');
                    row.className = 'list-row';
                    const timeRange = `${minsToTime(start)} - ${minsToTime(i)}`;
                    const badgeClass = current ? 'badge-on' : 'badge-off';
                    const icon = current ? 'üü¢' : 'üî¥';
                    const text = current ? T[lang].on : T[lang].off;
                    
                    row.innerHTML = `
                        <div class="row-time">${timeRange}</div>
                        <div class="row-badge ${badgeClass}">${icon} ${text}</div>
                    `;
                    listEl.appendChild(row);

                    current = map[i];
                    start = i;
                }
            }

            const outages = viewSchedule.queues[selectedQueue] || [];
            outages.forEach(o => {
                let s = timeToMins(o.start), e = timeToMins(o.end);
                if(e===0) e=1440;
                offMins += (e-s);
            });
            document.getElementById('val-off').innerText = fmtDur(offMins);
            document.getElementById('val-on').innerText = fmtDur(1440 - offMins);
        }

        function updateQuote(type) {
            if (typeof QUOTES_DB === 'undefined') return;
            if (lastStatusType !== type) {
                lastStatusType = type;
                const list = QUOTES_DB[lang][type];
                if (list && list.length > 0) {
                    const rnd = Math.floor(Math.random() * list.length);
                    const qEl = document.getElementById('quote');
                    qEl.style.opacity = 0;
                    setTimeout(() => {
                        qEl.innerText = list[rnd];
                        qEl.style.opacity = 0.9;
                    }, 200);
                }
            }
        }

        function tick() {
            if (!todaySchedule || !selectedQueue) return;

            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Kiev"}));
            const curMins = now.getHours() * 60 + now.getMinutes();
            const curSecs = curMins * 60 + now.getSeconds();

            document.getElementById('updated').innerText = `${T[lang].upd} ${todaySchedule.updated_at}`;

            const viewParts = viewSchedule.date.split(' ');
            const vD = parseInt(viewParts[0]);
            const vMIdx = UA_MONTHS.indexOf(viewParts[1].toUpperCase());
            const isViewingToday = (vD === now.getDate() && vMIdx === now.getMonth());

            const marker = document.getElementById('marker');
            if (isViewingToday) {
                marker.style.display = 'block';
                marker.style.left = (curMins / 1440 * 100) + '%';
            } else {
                marker.style.display = 'none';
            }

            const map = getDayMap(todaySchedule, selectedQueue);
            const isLight = map[curMins] !== undefined ? map[curMins] : true;
            
            let nextChange = -1;
            for(let i = curMins + 1; i < 1440; i++) {
                if(map[i] !== isLight) { nextChange = i; break; }
            }

            let totalSecsLeft = 0;
            let timeInfoStr = "";
            let eventTimeLabel = "";

            if (nextChange !== -1) {
                totalSecsLeft = (nextChange * 60) - curSecs;
                eventTimeLabel = minsToTime(nextChange);
            } else {
                const secsToMidnight = (1440 * 60) - curSecs;
                const currentIdx = DATA.indexOf(todaySchedule);
                const nextDaySchedule = DATA[currentIdx + 1];

                let foundChangeTomorrow = false;
                let nextChangeTom = -1;

                if (nextDaySchedule) {
                    const nextMap = getDayMap(nextDaySchedule, selectedQueue);
                    if (nextMap[0] === isLight) {
                        for(let i = 0; i < 1440; i++) {
                            if(nextMap[i] !== isLight) { nextChangeTom = i; break; }
                        }
                        if (nextChangeTom !== -1) {
                            totalSecsLeft = secsToMidnight + (nextChangeTom * 60);
                            eventTimeLabel = minsToTime(nextChangeTom);
                            timeInfoStr = `<span class="timer-note">(${T[lang].tom} ${T[lang].at} ${eventTimeLabel})</span>`;
                            foundChangeTomorrow = true;
                        } else {
                            totalSecsLeft = secsToMidnight;
                            eventTimeLabel = "24:00";
                        }
                    } else {
                        totalSecsLeft = secsToMidnight;
                        eventTimeLabel = "00:00";
                        timeInfoStr = `<span class="timer-note">(${T[lang].tom} ${T[lang].at} 00:00)</span>`;
                        foundChangeTomorrow = true;
                    }
                } 

                if (!foundChangeTomorrow) {
                    totalSecsLeft = secsToMidnight;
                    eventTimeLabel = "24:00";
                }
            }

            const h = Math.floor(totalSecsLeft / 3600);
            const m = Math.floor((totalSecsLeft % 3600) / 60);
            const s = Math.floor(totalSecsLeft % 60);
            const timeStr = `${pad(h)}:${pad(m)}:${pad(s)}`;

            const body = document.body;
            const icon = document.getElementById('icon');
            const st = document.getElementById('status');
            const tm = document.getElementById('timer');

            if (isLight) {
                body.classList.remove('dark-mode');
                icon.innerText = '‚ùÑÔ∏è'; // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ –∑–∏–º–Ω—é—é –ø—Ä–∏ —Å–≤–µ—Ç–µ
                // –ò–ª–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–ª–Ω—Ü–µ '‚òÄÔ∏è'
                icon.innerText = '‚òÄÔ∏è';
                st.innerText = T[lang].on;
                st.style.color = 'var(--text)';
                tm.innerHTML = `${T[lang].in_off} ${timeStr} ${timeInfoStr}`;
                updateQuote('on');
            } else {
                body.classList.add('dark-mode');
                icon.innerText = 'üïØÔ∏è';
                st.innerText = T[lang].off;
                st.style.color = 'var(--off)';
                tm.innerHTML = `${T[lang].in_on} ${timeStr} ${timeInfoStr}`;
                updateQuote('off');
            }
        }

        function getDayMap(schedule, queue) {
            const map = new Array(1440).fill(true);
            const list = schedule.queues[queue] || [];
            list.forEach(o => {
                let s = timeToMins(o.start), e = timeToMins(o.end);
                if(e===0) e=1440;
                for(let i=s; i<e; i++) if(i<1440) map[i] = false;
            });
            return map;
        }

        // --- MODAL & INFO ---
        function openInfo() {
            renderChangelog();
            const modal = document.getElementById('info-modal');
            modal.style.display = 'flex';
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ opacity
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeInfo() {
            const modal = document.getElementById('info-modal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function renderChangelog() {
            if (typeof CHANGELOG_DATA === 'undefined') return;
            const container = document.getElementById('changelog-container');
            container.innerHTML = '';
            
            CHANGELOG_DATA.forEach(ver => {
                const item = document.createElement('div');
                item.className = 'cl-item';
                
                const changesList = ver.changes[lang] || ver.changes['uk'];
                const listHtml = changesList.map(c => `<li>${c}</li>`).join('');

                item.innerHTML = `
                    <div class="cl-ver">
                        <span>v${ver.version}</span>
                        <span class="cl-date">${ver.date}</span>
                    </div>
                    <div class="cl-desc"><ul>${listHtml}</ul></div>
                `;
                container.appendChild(item);
            });
        }

        function timeToMins(s) { const p=s.split(':'); return parseInt(p[0])*60 + parseInt(p[1]); }
        function minsToTime(m) { 
            if(m===1440) return "24:00";
            return `${Math.floor(m/60).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}`;
        }
        function fmtDur(m) {
            const h = Math.floor(m/60), mn = m%60;
            if(h>0 && mn>0) return `${h}${T[lang].h} ${mn}${T[lang].m}`;
            if(h>0) return `${h} ${T[lang].h}`;
            return `${mn} ${T[lang].m}`;
        }
        function pad(n) { return n.toString().padStart(2,'0'); }

        init();
    </script>
</body>
</html>