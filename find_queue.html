<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ—à—É–∫ –ß–µ—Ä–≥–∏</title>
    
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;700;900&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --text: #2c3e50;
            --primary: #fbc02d;
            --bg-gradient: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        /* –¢–µ–º–Ω–∞ —Ç–µ–º–∞ (–≤–º–∏–∫–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ JS) */
        body.dark-mode {
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #f1f5f9;
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        body {
            margin: 0; padding: 20px;
            font-family: 'Nunito', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text);
            transition: background 0.5s;
        }

        #snow-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; overflow: hidden;
        }
        .snowflake {
            position: absolute; top: -10px; background: white;
            border-radius: 50%; opacity: 0.8; animation: fall linear infinite;
        }
        @keyframes fall { to { transform: translateY(105vh); } }

        .glass-panel {
            position: relative; z-index: 10;
            background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 24px;
            padding: 25px;
            max-width: 500px; margin: 0 auto;
            transition: all 0.3s ease;
        }

        /* --- –ö–†–ê–°–ò–í–ê –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î --- */
        .header-row {
            display: flex; align-items: center; margin-bottom: 25px;
        }
        .back-btn {
            text-decoration: none;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px; height: 44px;
            border-radius: 14px;
            background: rgba(255,255,255,0.4);
            border: 1px solid var(--glass-border);
            color: var(--text);
            font-size: 20px;
            transition: all 0.2s;
        }
        .back-btn:active { transform: scale(0.92); background: rgba(255,255,255,0.6); }
        
        body.dark-mode .back-btn {
            background: rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.1);
        }

        h1 {
            margin: 0; font-family: 'SF Pro Display', sans-serif;
            font-size: 22px; font-weight: 800;
        }

        /* INPUTS */
        .input-group { margin-bottom: 20px; position: relative; }
        label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 14px; opacity: 0.8; }
        
        input {
            width: 100%; padding: 16px; border-radius: 18px;
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.3);
            font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 600;
            color: var(--text); box-sizing: border-box; outline: none;
            transition: all 0.3s;
        }
        body.dark-mode input { background: rgba(0,0,0,0.2); }
        
        input:focus {
            background: rgba(255,255,255,0.8);
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(251, 192, 45, 0.15);
        }
        body.dark-mode input:focus { background: rgba(0,0,0,0.4); }

        /* LIST */
        .autocomplete-list {
            position: absolute; top: 105%; left: 0; right: 0;
            background: var(--glass-bg); backdrop-filter: blur(15px);
            border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 250px; overflow-y: auto; z-index: 100;
            padding: 5px; border: 1px solid var(--glass-border);
            display: none;
        }
        .autocomplete-item {
            padding: 12px 15px; cursor: pointer; border-radius: 10px;
            margin-bottom: 2px; font-size: 15px; color: var(--text);
        }
        .autocomplete-item:hover {
            background-color: rgba(251, 192, 45, 0.2); /* Yellow tint */
            font-weight: 700;
        }

        /* RESULT */
        #result-card {
            margin-top: 30px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border: 1px solid var(--glass-border);
            padding: 25px; border-radius: 20px; text-align: center;
            display: none; animation: popIn 0.4s ease;
        }
        #result-queue {
            font-family: 'SF Pro Display', sans-serif; font-size: 56px; font-weight: 900;
            background: linear-gradient(45deg, #fbc02d, #f57f17);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            display: block; line-height: 1; margin-top: 10px;
            filter: drop-shadow(0 4px 10px rgba(24bc2d, 0.3));
        }
        
        .loader { text-align: center; font-size: 14px; opacity: 0.7; margin-top: 10px; }
        @keyframes popIn { 0% { transform: scale(0.8) translateY(10px); opacity: 0; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="snow-container"></div>

    <div class="glass-panel">
        <div class="header-row">
            <a href="index.html" class="back-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 19L8 12L15 5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </a>
            <h1 id="title-text">–ü–æ—à—É–∫ —á–µ—Ä–≥–∏</h1>
        </div>
        
        <div id="loading-status" class="loader">üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

        <div class="input-group">
            <label>–í—É–ª–∏—Ü—è</label>
            <input type="text" id="street-input" placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É..." disabled autocomplete="off">
            <div id="street-list" class="autocomplete-list"></div>
        </div>

        <div class="input-group">
            <label>–ë—É–¥–∏–Ω–æ–∫</label>
            <input type="text" id="house-input" placeholder="–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –≤—É–ª–∏—Ü—é" disabled autocomplete="off">
            <div id="house-list" class="autocomplete-list"></div>
        </div>

        <div id="result-card">
            <div style="text-transform: uppercase; opacity: 0.6; font-size: 12px; letter-spacing: 1px;">–í–∞—à–∞ —á–µ—Ä–≥–∞</div>
            <span id="result-queue">-</span>
        </div>
    </div>

    <script>
        // Check theme from URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }

        // Snow animation
        function createSnow() {
            const container = document.getElementById('snow-container');
            const count = 20; 
            for (let i = 0; i < count; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                const size = Math.random() * 5 + 3; 
                flake.style.width = size + 'px'; flake.style.height = size + 'px';
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.animationDuration = Math.random() * 5 + 10 + 's';
                flake.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(flake);
            }
        }
        createSnow();

        // Logic
        const QUEUE_FILES = ["1.1.xlsx", "1.2.xlsx", "2.1.xlsx", "2.2.xlsx", "3.1.xlsx", "3.2.xlsx", "4.1.xlsx", "4.2.xlsx", "5.1.xlsx", "5.2.xlsx", "6.1.xlsx", "6.2.xlsx"];
        const BASE_PATH = "./xls/"; 
        let database = [], uniqueStreets = [], selectedStreet = null;

        async function init() {
            const statusEl = document.getElementById('loading-status');
            const streetInput = document.getElementById('street-input');
            try {
                const promises = QUEUE_FILES.map(file => loadQueueFile(file));
                await Promise.all(promises);
                processDatabase();
                statusEl.style.display = 'none';
                streetInput.disabled = false;
            } catch (e) {
                console.error(e);
                statusEl.innerText = "‚ùå –ü–æ–º–∏–ª–∫–∞ –±–∞–∑–∏";
                statusEl.style.color = "#ef5350";
            }
        }

        async function loadQueueFile(filename) {
            try {
                const response = await fetch(BASE_PATH + filename);
                if (!response.ok) return; 
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                parseRows(jsonData, filename.replace('.xlsx', ''));
            } catch (e) { console.warn(`Skip ${filename}`); }
        }

        function parseRows(rows, queueId) {
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length < 2) continue;
                const rawStreet = String(row[0]).trim();
                const cleanStreetName = normalizeStreetName(rawStreet);
                const houses = expandHouseRanges(String(row[1]).trim());
                houses.forEach(house => {
                    database.push({ fullStreet: rawStreet, cleanStreet: cleanStreetName, house: house, queue: queueId });
                });
            }
        }

        function processDatabase() {
            const streetSet = new Set(database.map(d => d.fullStreet));
            uniqueStreets = Array.from(streetSet).sort((a, b) => a.localeCompare(b));
        }

        function expandHouseRanges(rawStr) {
            const parts = rawStr.split(/[|,\/]/).map(s => s.trim()).filter(s => s);
            let result = new Set();
            parts.forEach(part => {
                const rangeMatch = part.match(/^(\d+)[-‚Äì‚Äî](\d+)$/);
                if (rangeMatch) {
                    const start = parseInt(rangeMatch[1]);
                    const end = parseInt(rangeMatch[2]);
                    if (!isNaN(start) && !isNaN(end) && end > start) {
                        const step = (start % 2 === end % 2) ? 2 : 1;
                        for (let i = start; i <= end; i += step) result.add(i.toString());
                    } else result.add(part);
                } else result.add(part);
            });
            return Array.from(result);
        }

        function normalizeStreetName(name) {
            return name.toLowerCase().replace(/^(–≤—É–ª\.|–ø—Ä–æ–≤\.|–ø—Ä–æ—ó–∑–¥|—à–æ—Å–µ|–±—É–ª\.|–ø—Ä\.|–ø–ª–æ—â–∞|–º–∞–π–¥–∞–Ω|—É–∑–≤—ñ–∑)\s*/g, '').trim();
        }

        const streetInput = document.getElementById('street-input');
        const houseInput = document.getElementById('house-input');
        const streetList = document.getElementById('street-list');
        const houseList = document.getElementById('house-list');
        const resultCard = document.getElementById('result-card');

        streetInput.addEventListener('input', (e) => {
            const val = normalizeStreetName(e.target.value);
            selectedStreet = null; houseInput.disabled = true; houseInput.value = '';
            resultCard.style.display = 'none'; houseList.style.display = 'none';
            if (val.length < 1) { streetList.style.display = 'none'; return; }
            const matches = uniqueStreets.filter(s => normalizeStreetName(s).startsWith(val));
            renderAutocomplete(streetList, matches, val, selectStreet);
        });

        function renderAutocomplete(container, matches, query, callback) {
            container.innerHTML = '';
            if (matches.length === 0) { container.style.display = 'none'; return; }
            matches.slice(0, 50).forEach(match => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerText = match; 
                div.onclick = () => callback(match);
                container.appendChild(div);
            });
            container.style.display = 'block';
        }

        function selectStreet(name) {
            streetInput.value = name; selectedStreet = name; streetList.style.display = 'none';
            houseInput.disabled = false; houseInput.value = ''; houseInput.focus(); showHouseOptions('');
        }

        houseInput.addEventListener('focus', () => { if(selectedStreet) showHouseOptions(houseInput.value); });
        houseInput.addEventListener('input', (e) => { showHouseOptions(e.target.value); });

        function showHouseOptions(val) {
            if (!selectedStreet) return;
            const housesOnStreet = database.filter(d => d.fullStreet === selectedStreet).map(d => d.house);
            const uniqueHouses = [...new Set(housesOnStreet)].sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            const matches = uniqueHouses.filter(h => h.toLowerCase().startsWith(val.toLowerCase()));
            renderAutocomplete(houseList, matches, val, selectHouse);
        }

        function selectHouse(house) {
            houseInput.value = house; houseList.style.display = 'none';
            const entry = database.find(d => d.fullStreet === selectedStreet && d.house === house);
            if (entry) {
                document.getElementById('result-queue').innerText = entry.queue;
                resultCard.style.display = 'block';
            }
        }

        document.addEventListener('click', (e) => {
            if (e.target !== streetInput) streetList.style.display = 'none';
            if (e.target !== houseInput) houseList.style.display = 'none';
        });

        init();
    </script>
</body>
</html>
