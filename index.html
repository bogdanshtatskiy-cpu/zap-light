<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–ü–í –ó–∞–ø–æ—Ä—ñ–∂–∂—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;700;900&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="quotes.js"></script> 
    <script src="changelog.js"></script>
    <script src="weather_advice.js"></script>
    <script src="weather.js"></script>
</head>
<body>
    <script>
        if (localStorage.getItem('isDarkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
    </script>

    <div class="header">
        <div class="header-left">
            <div class="info-btn" id="nav-back" onclick="showView('view-main')" style="display:none;">‚Üê</div>
            <div class="info-btn" id="nav-info" onclick="openInfo()">i</div>
            <div class="weather-toggle-btn active" id="weather-toggle" onclick="toggleWeatherWidget()">üå§Ô∏è</div>
        </div>
        <div class="title-wrap" id="title-wrap">
            <div class="app-title" id="app-title">‚ö° –ì–ü–í</div>
            <div class="app-subtitle" id="city-label">–º. –ó–∞–ø–æ—Ä—ñ–∂–∂—è</div>
        </div>
        <div class="lang-switch" id="lang-switch-container">
            <div class="lang-btn active" id="btn-uk" onclick="setLang('uk')">UA</div>
            <div class="lang-btn" id="btn-ru" onclick="setLang('ru')">RU</div>
        </div>
    </div>

    <div class="date-wrap" id="main-date-wrap">
        <div class="date-container" id="dates"></div>
    </div>

    <div id="view-main" class="view-section active">
        <div class="donate-wrap">
            <a href="https://mobile-app.pumb.ua/YCLM" target="_blank" class="glass-btn">
                <span>‚òï</span> <span id="donate-text">–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏</span>
            </a>
        </div>

        <div id="weather-widget" class="weather-widget glass-panel">
            <div class="w-current">
                <div class="w-main"><span class="w-icon" id="w-icon"></span><span class="w-temp" id="w-temp"></span></div>
                <div class="w-info"><div class="w-desc" id="w-desc"></div><div class="w-feel" id="w-feel"></div></div>
            </div>
            <div class="w-hourly" id="w-hourly"></div>
            <div class="w-advice"><div class="w-advice-text" id="w-advice-text">...</div></div>
        </div>
        
        <div class="warning-box" id="tentative-warning">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <span id="tentative-text">–¶–µ –æ—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫. –ú–æ–∂–ª–∏–≤—ñ –∑–º—ñ–Ω–∏.</span>
        </div>
        
        <div class="queue-grid" id="queues"></div>

        <div class="action-buttons-grid">
            <div onclick="showView('view-search')" class="glass-btn cursor-pointer">
                <span class="btn-icon">üîç</span><span id="find-label">–ó–Ω–∞–π—Ç–∏ —á–µ—Ä–≥—É</span>
            </div>
            <div onclick="showView('view-all')" class="glass-btn cursor-pointer">
                <span class="btn-icon">üìä</span><span id="all-label">–í—Å—ñ —á–µ—Ä–≥–∏</span>
            </div>
        </div>

        <div class="hero glass-panel" id="hero" style="display:none">
            <div class="bulb-icon-wrap" id="bulb-wrap"><div id="bulb-svg-container"></div></div>
            <div class="status-main" id="status">...</div>
            <div class="timer" id="timer">...</div>
            <div class="quote-box" id="quote"></div>
            <div class="last-update" id="updated"></div>
        </div>

        <div class="bar-wrap" id="bar-wrap" style="display:none">
            <div class="bar" id="visual"></div>
            <div class="marker" id="marker"></div>
            <div class="labels"><span>00</span><span>06</span><span>12</span><span>18</span><span>24</span></div>
        </div>

        <div class="stats" id="stats" style="display:none">
            <div class="stat-card"><span class="stat-label" id="lbl-on">–°–≤—ñ—Ç–ª–æ —î</span><div class="stat-val on" id="val-on">-</div></div>
            <div class="stat-card"><span class="stat-label" id="lbl-off">–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞</span><div class="stat-val off" id="val-off">-</div></div>
        </div>

        <div class="list-card glass-panel" id="details-list" style="display:none"></div>
        <div class="loader" id="loader">...</div>
    </div>

    <div id="view-search" class="view-section">
        <div class="glass-panel" style="margin-bottom: 20px;">
            <div id="loading-status" class="loader">üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–∞–∑–∏...</div>

            <div class="input-group">
                <label id="lbl-street">–í—É–ª–∏—Ü—è</label>
                <input type="text" id="street-input" placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É..." disabled autocomplete="off">
                <div id="street-list" class="autocomplete-list"></div>
            </div>

            <div class="input-group">
                <label id="lbl-house">–ë—É–¥–∏–Ω–æ–∫</label>
                <input type="text" id="house-input" placeholder="–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –≤—É–ª–∏—Ü—é" disabled autocomplete="off">
                <div id="house-list" class="autocomplete-list"></div>
            </div>

            <div id="result-card" style="display:none;">
                <div style="text-transform: uppercase; opacity: 0.6; font-size: 12px; letter-spacing: 1px;" id="lbl-res">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
                <span id="result-queue">-</span>
            </div>

            <div class="info-notes">
                <div class="note-item">
                    <span class="note-icon">‚ö°</span>
                    <span id="note-1">–Ø–∫—â–æ –≤–∞—à–æ—ó –∞–¥—Ä–µ—Å–∏ –Ω–µ–º–∞—î —É —Å–ø–∏—Å–∫—É ‚Äî –π–º–æ–≤—ñ—Ä–Ω–æ, –≥—Ä–∞—Ñ—ñ–∫–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –¥–æ –Ω–µ—ó <b>–Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è</b>.</span>
                </div>
            </div>
            
            <div class="action-buttons-grid" style="margin-top: 15px;">
                <div id="clear-btn" class="glass-btn cursor-pointer">
                    <span class="btn-icon">üßπ</span><span id="clear-label">–û—á–∏—Å—Ç–∏—Ç–∏</span>
                </div>
            </div>
        </div>
    </div>

    <div id="view-all" class="view-section">
        <div class="glass-panel" id="matrix-container" style="padding: 15px;">
            <div class="loader">–§–æ—Ä–º—É–≤–∞–Ω–Ω—è –º–∞—Ç—Ä–∏—Ü—ñ...</div>
        </div>
    </div>

    <div id="info-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title" id="modal-title">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</div><div class="close-btn" onclick="closeInfo()">√ó</div></div>
            <div class="dev-info"><div style="font-size:13px; opacity:0.6; margin-bottom:2px; text-transform:uppercase; letter-spacing:1px;" id="dev-label">–†–æ–∑—Ä–æ–±–Ω–∏–∫</div><div class="dev-nick">DesOope</div><a href="https://t.me/desoope" target="_blank" class="dev-link">Telegram</a></div>
            <div style="font-size:12px; font-weight:800; opacity:0.4; margin-bottom:10px; text-transform:uppercase; letter-spacing: 1px;" id="cl-label">–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω</div>
            <div class="changelog-list" id="changelog-container"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const SVG_BULB_ON = `<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="gradOn" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ffeb3b;stop-opacity:1"/><stop offset="100%" style="stop-color:#ffc107;stop-opacity:1"/></linearGradient><filter id="glow" x="-20%" y="-20%" width="140%" height="140%"><feGaussianBlur stdDeviation="5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><path fill="url(#gradOn)" filter="url(#glow)" d="M256,0C158.5,0,79.4,79.1,79.4,176.6c0,42.4,15.1,81.4,40.1,111.7l19.1,23.3c7.2,8.8,11.3,19.9,11.3,31.3v42.5 c0,22.1,17.9,40,40,40h132.3c22.1,0,40-17.9,40-40v-42.5c0-11.4,4.1-22.5,11.3-31.3l19.1-23.3c25-30.3,40.1-69.3,40.1-111.7 C432.6,79.1,353.5,0,256,0z M256,220c-24.3,0-44-19.7-44-44s19.7-44,44-44s44,19.7,44,44S280.3,220,256,220z"/><path fill="#e0e0e0" d="M189.9,425.4h132.3v30.9c0,8.3-6.7,15-15,15H204.9c-8.3,0-15-6.7-15-15V425.4z"/><path fill="#bdbdbd" d="M204.9,493.3h102.2c8.3,0,15-6.7,15-15v-6.9H189.9v6.9C189.9,486.6,196.6,493.3,204.9,493.3z"/></svg>`;
        const SVG_BULB_OFF = `<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="gradOff" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#90a4ae;stop-opacity:1"/><stop offset="100%" style="stop-color:#607d8b;stop-opacity:1"/></linearGradient></defs><path fill="url(#gradOff)" d="M256,0C158.5,0,79.4,79.1,79.4,176.6c0,42.4,15.1,81.4,40.1,111.7l19.1,23.3c7.2,8.8,11.3,19.9,11.3,31.3v42.5 c0,22.1,17.9,40,40,40h132.3c22.1,0,40-17.9,40-40v-42.5c0-11.4,4.1-22.5,11.3-31.3l19.1-23.3c25-30.3,40.1-69.3,40.1-111.7 C432.6,79.1,353.5,0,256,0z M256,150c-10,0-18,8-18,18s8,18,18,18s18-8,18-18S266,150,256,150z"/><path fill="#78909c" d="M189.9,425.4h132.3v30.9c0,8.3-6.7,15-15,15H204.9c-8.3,0-15-6.7-15-15V425.4z"/><path fill="#546e7a" d="M204.9,493.3h102.2c8.3,0,15-6.7,15-15v-6.9H189.9v6.9C189.9,486.6,196.6,493.3,204.9,493.3z"/></svg>`;

        const UA_MONTHS = ["–°–Ü–ß–ù–Ø", "–õ–Æ–¢–û–ì–û", "–ë–ï–†–ï–ó–ù–Ø", "–ö–í–Ü–¢–ù–Ø", "–¢–†–ê–í–ù–Ø", "–ß–ï–†–í–ù–Ø", "–õ–ò–ü–ù–Ø", "–°–ï–†–ü–ù–Ø", "–í–ï–†–ï–°–ù–Ø", "–ñ–û–í–¢–ù–Ø", "–õ–ò–°–¢–û–ü–ê–î–ê", "–ì–†–£–î–ù–Ø"];
        const WEEKDAYS = {
            uk: ['–ù–¥', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'],
            ru: ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±']
        };
        
        let DATA = [];
        let generatedAt = "";
        let todaySchedule = null;
        let viewSchedule = null;
        let selectedQueue = localStorage.getItem('queue');
        let lang = localStorage.getItem('lang') || 'uk';
        let lastStatusType = null; 
        
        let currentView = 'view-main';
        let isSearchLoaded = false;

        const T = {
            uk: { 
                title: "‚ö° –ì–ü–í", city: "–º. –ó–∞–ø–æ—Ä—ñ–∂–∂—è", load: "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...", nodata: "–î–∞–Ω–∏—Ö –Ω–µ–º–∞—î", choose: "–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É", 
                on: "–°–í–Ü–¢–õ–û –Ñ", off: "–°–í–Ü–¢–õ–ê –ù–ï–ú–ê", in_on: "–í–≤—ñ–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑:", in_off: "–í–∏–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑:", 
                upd: "–ê–∫—Ç—É–∞–ª—å–Ω–æ –Ω–∞:", h: "–≥", m: "—Ö–≤", lbl_on: "–°–≤—ñ—Ç–ª–æ —î", lbl_off: "–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞",
                tom: "–∑–∞–≤—Ç—Ä–∞", at: "–≤", modal_title: "–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è", dev: "–†–æ–∑—Ä–æ–±–Ω–∏–∫", cl: "–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω",
                support: "–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏", find_q: "–ó–Ω–∞–π—Ç–∏ —á–µ—Ä–≥—É", all_q: "–í—Å—ñ —á–µ—Ä–≥–∏",
                tentative: "–¶–µ –æ—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫. –ú–æ–∂–ª–∏–≤—ñ –∑–º—ñ–Ω–∏.",
                search_title: "–ü–æ—à—É–∫ —á–µ—Ä–≥–∏", street: "–í—É–ª–∏—Ü—è", house: "–ë—É–¥–∏–Ω–æ–∫", res: "–†–µ–∑—É–ª—å—Ç–∞—Ç",
                clear: "–û—á–∏—Å—Ç–∏—Ç–∏", note1: "–Ø–∫—â–æ –≤–∞—à–æ—ó –∞–¥—Ä–µ—Å–∏ –Ω–µ–º–∞—î —É —Å–ø–∏—Å–∫—É ‚Äî –π–º–æ–≤—ñ—Ä–Ω–æ, –≥—Ä–∞—Ñ—ñ–∫–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –¥–æ –Ω–µ—ó <b>–Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è</b>.",
                matrix_title: "–ú–∞—Ç—Ä–∏—Ü—è —á–µ—Ä–≥", total: "–í—Å—å–æ–≥–æ",
                search_ph_street: "–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É...", search_ph_house_1: "–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –≤—É–ª–∏—Ü—é", search_ph_house_2: "–¢–µ–ø–µ—Ä –æ–±–µ—Ä—ñ—Ç—å –±—É–¥–∏–Ω–æ–∫"
            },
            ru: { 
                title: "‚ö° –ì–ü–û", city: "–≥. –ó–∞–ø–æ—Ä–æ–∂—å–µ", load: "–ó–∞–≥—Ä—É–∑–∫–∞...", nodata: "–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç", choose: "–í—ã–±–µ—Ä–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å", 
                on: "–°–í–ï–¢ –ï–°–¢–¨", off: "–°–í–ï–¢–ê –ù–ï–¢", in_on: "–í–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑:", in_off: "–û—Ç–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑:", 
                upd: "–ê–∫—Ç—É–∞–ª—å–Ω–æ –Ω–∞:", h: "—á", m: "–º", lbl_on: "–°–≤–µ—Ç –µ—Å—Ç—å", lbl_off: "–°–≤–µ—Ç–∞ –Ω–µ—Ç",
                tom: "–∑–∞–≤—Ç—Ä–∞", at: "–≤", modal_title: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", dev: "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫", cl: "–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π",
                support: "–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å", find_q: "–ù–∞–π—Ç–∏ –æ—á–µ—Ä–µ–¥—å", all_q: "–í—Å–µ –æ—á–µ—Ä–µ–¥–∏",
                tentative: "–≠—Ç–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫. –í–æ–∑–º–æ–∂–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è.",
                search_title: "–ü–æ–∏—Å–∫ –æ—á–µ—Ä–µ–¥–∏", street: "–£–ª–∏—Ü–∞", house: "–î–æ–º", res: "–†–µ–∑—É–ª—å—Ç–∞—Ç",
                clear: "–û—á–∏—Å—Ç–∏—Ç—å", note1: "–ï—Å–ª–∏ –≤–∞—à–µ–≥–æ –∞–¥—Ä–µ—Å–∞ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ, –≥—Ä–∞—Ñ–∏–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–π –∫ –Ω–µ–º—É <b>–Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è</b>.",
                matrix_title: "–ú–∞—Ç—Ä–∏—Ü–∞ –æ—á–µ—Ä–µ–¥–µ–π", total: "–í—Å–µ–≥–æ",
                search_ph_street: "–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ...", search_ph_house_1: "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É–ª–∏—Ü—É", search_ph_house_2: "–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ–º"
            }
        };

        function showView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            currentView = viewId;
            window.scrollTo({ top: 0, behavior: 'smooth' });

            const btnBack = document.getElementById('nav-back');
            const btnInfo = document.getElementById('nav-info');
            const langSwitch = document.getElementById('lang-switch-container');
            const titleWrap = document.getElementById('title-wrap');
            const weatherToggle = document.getElementById('weather-toggle');
            const dateWrap = document.getElementById('main-date-wrap');

            if (viewId === 'view-main') {
                btnBack.style.display = 'none';
                btnInfo.style.display = 'flex';
                langSwitch.style.display = 'flex';
                titleWrap.style.display = 'block';
                weatherToggle.style.display = 'flex';
                dateWrap.style.display = 'block';
            } else {
                btnBack.style.display = 'flex';
                btnInfo.style.display = 'none';
                langSwitch.style.display = 'none';
                titleWrap.style.display = 'none';
                weatherToggle.style.display = 'none';

                if (viewId === 'view-search') {
                    dateWrap.style.display = 'none';
                    if(!isSearchLoaded) initSearchEngine();
                } else if (viewId === 'view-all') {
                    dateWrap.style.display = 'block';
                    renderMatrix();
                }
            }
        }

        async function init() {
            setLang(lang);
            if (typeof initWeather === "function") await initWeather(); 
            document.getElementById('loader').innerText = T[lang].load;

            try {
                const res = await fetch('https://raw.githubusercontent.com/bogdanshtatskiy-cpu/zap-light/main/schedule.json?v=' + Date.now());
                if (!res.ok) throw new Error("Failed to fetch");
                const json = await res.json();
                DATA = json.schedules;
                generatedAt = json.generated_at || "";

                if (!DATA || DATA.length === 0) {
                    document.getElementById('loader').innerText = T[lang].nodata;
                    return;
                }

                document.getElementById('loader').style.display = 'none';
                renderQueues();
                
                const kievDate = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Kiev"}));
                const todayDay = kievDate.getDate();
                const todayMonthIdx = kievDate.getMonth();

                let todayIdx = -1;
                DATA.forEach((item, idx) => {
                    const parts = item.date.split(' ');
                    const d = parseInt(parts[0]);
                    const mIdx = UA_MONTHS.indexOf(parts[1].toUpperCase());
                    if (d === todayDay && mIdx === todayMonthIdx) todayIdx = idx;
                });

                const activeIdx = todayIdx !== -1 ? todayIdx : DATA.length - 1;
                todaySchedule = DATA[activeIdx]; 
                
                renderDates(activeIdx);
                selectDate(activeIdx);

                if (selectedQueue) selectQueue(selectedQueue);
                else {
                    document.getElementById('hero').style.display = 'block';
                    document.getElementById('status').innerText = T[lang].choose;
                }

                setInterval(tick, 1000);
                tick();

            } catch (e) {
                console.error(e);
                document.getElementById('loader').innerText = "Error loading data";
            }
        }

        function renderDates(activeIdx) {
            const container = document.getElementById('dates');
            container.innerHTML = '';
            const kievDate = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Kiev"}));
            const currentYear = kievDate.getFullYear();

            DATA.forEach((item, idx) => {
                const btn = document.createElement('div');
                btn.className = `date-tab ${idx === activeIdx ? 'active' : ''}`;
                let dateLabel = item.date;
                let weekdayHtml = '';
                
                const parts = item.date.split(' ');
                if (parts.length === 2) {
                    const day = parseInt(parts[0]);
                    const mIdx = UA_MONTHS.indexOf(parts[1].toUpperCase());
                    if (mIdx !== -1) {
                        const monthNum = (mIdx + 1).toString().padStart(2, '0');
                        dateLabel = `${day.toString().padStart(2, '0')}.${monthNum}`;
                        const dateObj = new Date(currentYear, mIdx, day);
                        const dayOfWeek = dateObj.getDay();
                        weekdayHtml = `<div class="weekday-label ${(dayOfWeek===0||dayOfWeek===6)?'is-weekend':''}">${WEEKDAYS[lang][dayOfWeek]}</div>`;
                    }
                }
                btn.innerHTML = `${weekdayHtml}<div class="date-value">${dateLabel}</div>`;
                btn.onclick = () => { selectDate(idx); renderDates(idx); if(currentView === 'view-all') renderMatrix(); };
                container.appendChild(btn);
            });
        }

        function renderQueues() {
            const el = document.getElementById('queues');
            const qs = ["1.1", "1.2", "2.1", "2.2", "3.1", "3.2", "4.1", "4.2", "5.1", "5.2", "6.1", "6.2"];
            el.innerHTML = '';
            qs.forEach(q => {
                const btn = document.createElement('div');
                btn.className = `queue-btn ${q === selectedQueue ? 'active' : ''}`;
                btn.innerText = q;
                btn.onclick = () => selectQueue(q);
                el.appendChild(btn);
            });
        }

        function selectDate(idx) {
            viewSchedule = DATA[idx]; 
            if (typeof renderWeatherForDate === "function") renderWeatherForDate(viewSchedule.date);
            const kievDate = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Kiev"}));
            const tomorrow = new Date(kievDate); tomorrow.setDate(kievDate.getDate() + 1); tomorrow.setHours(0,0,0,0);
            const scheduleDateObj = new Date(kievDate.getFullYear(), UA_MONTHS.indexOf(viewSchedule.date.split(' ')[1].toUpperCase()), parseInt(viewSchedule.date.split(' ')[0]));

            document.getElementById('tentative-warning').style.display = (scheduleDateObj > tomorrow) ? 'flex' : 'none';
            if (selectedQueue) updateView();
        }

        function selectQueue(q) {
            selectedQueue = q; localStorage.setItem('queue', q);
            document.querySelectorAll('.queue-btn').forEach(b => {
                b.classList.toggle('active', b.innerText === q);
            });
            document.getElementById('hero').style.display = 'block';
            document.getElementById('bar-wrap').style.display = 'block';
            document.getElementById('stats').style.display = 'grid';
            document.getElementById('details-list').style.display = 'block';
            lastStatusType = null;
            tick(); updateView();
        }

        function setLang(l) {
            lang = l; localStorage.setItem('lang', l);
            document.getElementById('btn-uk').className = `lang-btn ${l==='uk'?'active':''}`;
            document.getElementById('btn-ru').className = `lang-btn ${l==='ru'?'active':''}`;
            
            document.getElementById('app-title').innerText = T[l].title;
            document.getElementById('city-label').innerText = T[l].city;
            document.getElementById('lbl-on').innerText = T[l].lbl_on;
            document.getElementById('lbl-off').innerText = T[l].lbl_off;
            document.getElementById('modal-title').innerText = T[l].modal_title;
            document.getElementById('dev-label').innerText = T[l].dev;
            document.getElementById('cl-label').innerText = T[l].cl;
            document.getElementById('find-label').innerText = T[l].find_q;
            document.getElementById('all-label').innerText = T[l].all_q;
            document.getElementById('tentative-text').innerText = T[l].tentative;
            document.getElementById('donate-text').innerText = T[l].support;
            
            // Search View Translations
            document.getElementById('lbl-street').innerText = T[l].street;
            document.getElementById('lbl-house').innerText = T[l].house;
            document.getElementById('lbl-res').innerText = T[l].res;
            document.getElementById('clear-label').innerText = T[l].clear;
            document.getElementById('note-1').innerHTML = T[l].note1;
            document.getElementById('street-input').placeholder = T[l].search_ph_street;
            document.getElementById('house-input').placeholder = selectedStreet ? T[l].search_ph_house_2 : T[l].search_ph_house_1;

            if(DATA.length) {
                const idx = DATA.indexOf(viewSchedule);
                renderDates(idx !== -1 ? idx : 0);
                if (!selectedQueue) document.getElementById('status').innerText = T[l].choose;
                else { updateView(); tick(); }
            }
            if(currentView === 'view-all') renderMatrix();
            renderChangelog();
        }

        function updateView() {
            if (!viewSchedule || !selectedQueue) return;
            const listEl = document.getElementById('details-list');
            const listFrag = document.createDocumentFragment();
            const timeline = document.getElementById('visual');
            const barFrag = document.createDocumentFragment();
            const map = getDayMap(viewSchedule, selectedQueue);
            
            let current = map[0]; let start = 0;
            for(let i=1; i<=1440; i++) {
                if(i===1440 || map[i] !== current) {
                    const d = document.createElement('div');
                    d.className = `chunk ${current ? 'on' : 'off'}`;
                    d.style.flexBasis = ((i-start)/1440*100) + '%';
                    barFrag.appendChild(d);

                    const row = document.createElement('div');
                    row.className = 'list-row';
                    row.style.animationDelay = `${listFrag.children.length * 0.05}s`;
                    
                    const timeRange = `${minsToTime(start)} - ${minsToTime(i)}`;
                    const badgeClass = current ? 'badge-on' : 'badge-off';
                    const text = current ? T[lang].on : T[lang].off;
                    const uid = `row_${start}`; 
                    let rawSvg = current ? SVG_BULB_ON : SVG_BULB_OFF;
                    rawSvg = rawSvg.replaceAll('id="', `id="${uid}_`).replaceAll('url(#', `url(#${uid}_`);
                    row.innerHTML = `<div class="row-time">${timeRange}</div><div class="row-badge ${badgeClass}"><div class="list-icon">${rawSvg}</div> ${text}</div>`;
                    listFrag.appendChild(row);
                    current = map[i]; start = i;
                }
            }
            timeline.innerHTML = ''; timeline.appendChild(barFrag);
            listEl.innerHTML = ''; listEl.appendChild(listFrag);

            let offCount = 0;
            for(let i=0; i<1440; i++) { if(map[i] === false) offCount++; }
            document.getElementById('val-off').innerText = fmtDur(offCount);
            document.getElementById('val-on').innerText = fmtDur(1440 - offCount);
        }

        function updateQuote(type) {
            if (typeof QUOTES_DB === 'undefined') return;
            if (lastStatusType !== type) {
                lastStatusType = type;
                const list = QUOTES_DB[lang][type];
                if (list && list.length > 0) {
                    const rnd = Math.floor(Math.random() * list.length);
                    const qEl = document.getElementById('quote');
                    qEl.style.opacity = 0;
                    setTimeout(() => { qEl.innerText = list[rnd]; qEl.style.opacity = 0.9; }, 200);
                }
            }
        }

        function tick() {
            if (!todaySchedule || !selectedQueue || currentView !== 'view-main') return;
            const updateTimeStr = generatedAt || todaySchedule.updated_at;
            const updEl = document.getElementById('updated');
            if (updEl.innerText !== `${T[lang].upd} ${updateTimeStr}`) updEl.innerText = `${T[lang].upd} ${updateTimeStr}`;

            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Kiev"}));
            const curMins = now.getHours() * 60 + now.getMinutes();
            const curSecs = curMins * 60 + now.getSeconds();

            const isViewingToday = (parseInt(viewSchedule.date.split(' ')[0]) === now.getDate());
            const marker = document.getElementById('marker');
            marker.style.display = isViewingToday ? 'block' : 'none';
            if(isViewingToday) marker.style.left = (curMins / 1440 * 100) + '%';

            const map = getDayMap(todaySchedule, selectedQueue);
            const isLight = map[curMins] !== undefined ? map[curMins] : true;
            
            let nextChange = -1;
            for(let i = curMins + 1; i < 1440; i++) {
                if(map[i] !== isLight) { nextChange = i; break; }
            }

            let totalSecsLeft = 0; let timeInfoStr = "";
            if (nextChange !== -1) {
                totalSecsLeft = (nextChange * 60) - curSecs;
            } else {
                const secsToMidnight = (1440 * 60) - curSecs;
                const nextDaySchedule = DATA[DATA.indexOf(todaySchedule) + 1];
                let foundChangeTomorrow = false; let nextChangeTom = -1;
                if (nextDaySchedule) {
                    const nextMap = getDayMap(nextDaySchedule, selectedQueue);
                    if (nextMap[0] === isLight) {
                        for(let i = 0; i < 1440; i++) { if(nextMap[i] !== isLight) { nextChangeTom = i; break; } }
                        if (nextChangeTom !== -1) {
                            totalSecsLeft = secsToMidnight + (nextChangeTom * 60);
                            timeInfoStr = `<span class="timer-note">(${T[lang].tom} ${T[lang].at} ${minsToTime(nextChangeTom)})</span>`;
                            foundChangeTomorrow = true;
                        }
                    } else {
                        totalSecsLeft = secsToMidnight;
                        timeInfoStr = `<span class="timer-note">(${T[lang].tom} ${T[lang].at} 00:00)</span>`;
                        foundChangeTomorrow = true;
                    }
                } 
                if (!foundChangeTomorrow) totalSecsLeft = secsToMidnight;
            }

            const h = Math.floor(totalSecsLeft / 3600); const m = Math.floor((totalSecsLeft % 3600) / 60); const s = Math.floor(totalSecsLeft % 60);
            const timeStr = `${pad(h)}:${pad(m)}:${pad(s)}`;
            const body = document.body;
            const iconContainer = document.getElementById('bulb-svg-container');
            const bulbWrap = document.getElementById('bulb-wrap');
            const st = document.getElementById('status');
            const tm = document.getElementById('timer');

            if (isLight) {
                body.classList.remove('dark-mode');
                localStorage.setItem('isDarkMode', 'false');
                if (iconContainer.innerHTML !== SVG_BULB_ON) { iconContainer.innerHTML = SVG_BULB_ON; bulbWrap.classList.add('bulb-on-glow'); }
                st.innerText = T[lang].on; st.style.color = 'var(--text)';
                const newHtml = `${T[lang].in_off} ${timeStr} ${timeInfoStr}`;
                if (tm.innerHTML !== newHtml) tm.innerHTML = newHtml; updateQuote('on');
            } else {
                body.classList.add('dark-mode');
                localStorage.setItem('isDarkMode', 'true');
                if (iconContainer.innerHTML !== SVG_BULB_OFF) { iconContainer.innerHTML = SVG_BULB_OFF; bulbWrap.classList.remove('bulb-on-glow'); }
                st.innerText = T[lang].off; st.style.color = 'var(--off)';
                const newHtml = `${T[lang].in_on} ${timeStr} ${timeInfoStr}`;
                if (tm.innerHTML !== newHtml) tm.innerHTML = newHtml; updateQuote('off');
            }
        }

        // ================= SPA: –ü–û–®–£–ö =================
        let dbSearch = [], uniqueStreets = [], selectedStreet = null;
        async function initSearchEngine() {
            isSearchLoaded = true;
            const statusEl = document.getElementById('loading-status');
            const streetInput = document.getElementById('street-input');
            const QUEUE_FILES = ["1.1.xlsx", "1.2.xlsx", "2.1.xlsx", "2.2.xlsx", "3.1.xlsx", "3.2.xlsx", "4.1.xlsx", "4.2.xlsx", "5.1.xlsx", "5.2.xlsx", "6.1.xlsx", "6.2.xlsx"];
            try {
                const promises = QUEUE_FILES.map(file => fetch("./xls/" + file).then(r => r.arrayBuffer()).then(ab => {
                    const wb = XLSX.read(ab, { type: 'array' });
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                    for(let i=0; i<rows.length; i++) {
                        if(!rows[i] || rows[i].length < 2) continue;
                        const rawStreet = String(rows[i][0]).trim(); const rawHouses = String(rows[i][1]).trim();
                        if (rawStreet.toLowerCase().includes('–≤—É–ª–∏—Ü—è') && rawHouses.toLowerCase().includes('–±—É–¥–∏–Ω–æ–∫')) continue;
                        const parts = rawHouses.split(/[|,\/]/).map(s => s.trim()).filter(s => s);
                        parts.forEach(part => {
                            const rangeMatch = part.match(/^(\d+)[-‚Äì‚Äî](\d+)$/);
                            if (rangeMatch && !isNaN(rangeMatch[1]) && !isNaN(rangeMatch[2])) {
                                const step = (parseInt(rangeMatch[1]) % 2 === parseInt(rangeMatch[2]) % 2) ? 2 : 1;
                                for (let j = parseInt(rangeMatch[1]); j <= parseInt(rangeMatch[2]); j += step) dbSearch.push({ fullStreet: rawStreet, house: j.toString(), queue: file.replace('.xlsx', '') });
                            } else dbSearch.push({ fullStreet: rawStreet, house: part, queue: file.replace('.xlsx', '') });
                        });
                    }
                }).catch(() => {}));
                await Promise.all(promises);
                uniqueStreets = Array.from(new Set(dbSearch.map(d => d.fullStreet))).sort((a, b) => a.localeCompare(b));
                statusEl.style.display = 'none'; streetInput.disabled = false;
            } catch(e) { statusEl.innerText = "‚ùå –ü–æ–º–∏–ª–∫–∞ –±–∞–∑–∏"; statusEl.style.color = "#ef5350"; }
        }

        const sInput = document.getElementById('street-input'), hInput = document.getElementById('house-input');
        const sList = document.getElementById('street-list'), hList = document.getElementById('house-list');
        const resCard = document.getElementById('result-card'), resQ = document.getElementById('result-queue');
        
        document.getElementById('clear-btn').addEventListener('click', () => {
            sInput.value = ''; hInput.value = ''; hInput.disabled = true; selectedStreet = null;
            hInput.placeholder = T[lang].search_ph_house_1;
            resCard.style.display = 'none'; sList.style.display = 'none'; hList.style.display = 'none'; sInput.focus();
        });

        sInput.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase(); selectedStreet = null; hInput.disabled = true; hInput.value = ''; 
            hInput.placeholder = T[lang].search_ph_house_1;
            resCard.style.display = 'none'; hList.style.display = 'none';
            if (val.length < 1) { sList.style.display = 'none'; return; }
            
            const matches = uniqueStreets.filter(s => {
                const clean = s.toLowerCase().replace(/^(–≤—É–ª\.|–ø—Ä–æ–≤\.|–±—É–ª\.|–ø—Ä\.|–ø–ª–æ—â–∞|–º–∞–π–¥–∞–Ω|—É–∑–≤—ñ–∑|—Ç—É–ø–∏–∫)\s*/g, '').replace(/[()]/g, ' ');
                return clean.split(/\s+/).some(k => k.startsWith(val));
            }).slice(0, 50);
            
            sList.innerHTML = '';
            if(matches.length) { matches.forEach(m => { const d = document.createElement('div'); d.className='autocomplete-item'; d.innerText=m; d.onclick=() => { sInput.value = m; selectedStreet = m; sList.style.display='none'; hInput.disabled=false; hInput.placeholder=T[lang].search_ph_house_2; hInput.focus(); }; sList.appendChild(d); }); sList.style.display = 'block'; }
            else sList.style.display = 'none';
        });

        hInput.addEventListener('input', (e) => {
            const val = e.target.value;
            const houses = [...new Set(dbSearch.filter(d => d.fullStreet === selectedStreet).map(d => d.house))].filter(h => h.toLowerCase().startsWith(val.toLowerCase())).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            hList.innerHTML = '';
            if(houses.length && val) { houses.forEach(h => { const d = document.createElement('div'); d.className='autocomplete-item'; d.innerText=h; d.onclick=() => { hInput.value=h; hList.style.display='none'; checkHouse(h); }; hList.appendChild(d); }); hList.style.display='block'; }
            else hList.style.display='none';
            checkHouse(val);
        });

        function checkHouse(val) {
            if (!selectedStreet || val.trim() === "") { resCard.style.display = 'none'; return; }
            const entry = dbSearch.find(d => d.fullStreet === selectedStreet && d.house.toLowerCase() === val.toLowerCase());
            resQ.innerText = entry ? entry.queue : "–ù–µ –≤—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è";
            resQ.style.background = entry ? "linear-gradient(45deg, #fbc02d, #f57f17)" : "linear-gradient(45deg, #4caf50, #8bc34a)";
            resQ.style.webkitBackgroundClip = "text"; resQ.style.webkitTextFillColor = "transparent";
            resCard.style.display = 'block';
        }

        // ================= SPA: –ú–ê–¢–†–ò–¶–Ø =================
        function renderMatrix() {
            if(!viewSchedule) return;
            const container = document.getElementById('matrix-container');
            const qs = ["1.1", "1.2", "2.1", "2.2", "3.1", "3.2", "4.1", "4.2", "5.1", "5.2", "6.1", "6.2"];
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Kiev"}));
            const isToday = (parseInt(viewSchedule.date.split(' ')[0]) === now.getDate());

            let html = `<div class="matrix-layout matrix-header"><div>–ß–µ—Ä–≥–∞</div><div class="time-labels"><span>00</span><span>06</span><span>12</span><span>18</span><span>24</span></div><div style="text-align:right">${T[lang].total}</div></div>`;
            
            html += `<div class="matrix-rows-wrapper" style="position: relative;">`;
            
            if (isToday) {
                const percent = ((now.getHours() * 60 + now.getMinutes()) / 1440) * 100;
                html += `<div class="time-cursor" style="left: calc(43px + (100% - 96px) * ${percent / 100})"></div>`;
            }

            qs.forEach(qKey => {
                const map = getDayMap(viewSchedule, qKey);
                let hourCellsHTML = ''; let offMins = 0;
                for(let h=0; h<24; h++) {
                    let isOff = false;
                    for(let m=0; m<60; m++) { if(map[h*60+m] === false) { isOff=true; offMins++; } }
                    hourCellsHTML += `<div class="hour-cell ${isOff ? 'off' : 'on'}"></div>`;
                }
                const stats = offMins===0 ? '<span style="color:var(--chunk-on); font-weight:900;">‚úì</span>' : `-${Math.floor(offMins/60).toString().padStart(2,'0')}:${(offMins%60).toString().padStart(2,'0')}`;
                html += `<div class="matrix-layout queue-row"><div class="q-name">${qKey}</div><div class="q-visual">${hourCellsHTML}</div><div class="q-stats">${stats}</div></div>`;
            });
            html += `</div>`; 
            container.innerHTML = html;
        }

        function getDayMap(schedule, queue) {
            const map = new Array(1440).fill(true);
            const list = schedule.queues[queue] || [];
            list.forEach(o => { let s=timeToMins(o.start), e=timeToMins(o.end); if(e===0) e=1440; for(let i=s; i<e; i++) if(i<1440) map[i]=false; });
            return map;
        }

        function openInfo() { renderChangelog(); document.getElementById('info-modal').style.display='flex'; setTimeout(() => document.getElementById('info-modal').classList.add('show'), 10); }
        function closeInfo() { document.getElementById('info-modal').classList.remove('show'); setTimeout(() => document.getElementById('info-modal').style.display='none', 300); }
        function renderChangelog() {
            if (typeof CHANGELOG_DATA === 'undefined') return;
            document.getElementById('changelog-container').innerHTML = CHANGELOG_DATA.map(v => `<div class="cl-item"><div class="cl-ver">v${v.version}</div><span class="cl-date">${v.date}</span><div class="cl-desc"><ul>${(v.changes[lang]||v.changes['uk']).map(c=>`<li>${c}</li>`).join('')}</ul></div></div>`).join('');
        }
        function timeToMins(s) { const p=s.split(':'); return parseInt(p[0])*60 + parseInt(p[1]); }
        function minsToTime(m) { return m===1440 ? "24:00" : `${Math.floor(m/60).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}`; }
        function fmtDur(m) { const h = Math.floor(m/60), mn = m%60; if(h>0 && mn>0) return `${h}${T[lang].h} ${mn}${T[lang].m}`; if(h>0) return `${h}${T[lang].h}`; return `${mn}${T[lang].m}`; }
        function pad(n) { return n.toString().padStart(2,'0'); }

        init();
    </script>
</body>
</html>
