<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–≤—ñ—Ç–ª–æ –ó–∞–ø–æ—Ä—ñ–∂–∂—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f8ff;
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.85);
            --accent-color: #4facfe;
            --status-bg: #e6f7ff;
            --shadow: 0 8px 20px rgba(0,0,0,0.08);
            --on-color: #4cd964;
            --off-color: #ff3b30;
            --card-border: rgba(255,255,255,0.4);
            --text-secondary: rgba(0,0,0,0.5);
        }

        body.dark-mode {
            --bg-color: #121212;
            --text-color: #ffffff;
            --card-bg: rgba(30, 30, 30, 0.85);
            --accent-color: #ff9500;
            --status-bg: #2c2c2c;
            --shadow: 0 8px 20px rgba(0,0,0,0.4);
            --card-border: rgba(255,255,255,0.1);
            --text-secondary: rgba(255,255,255,0.5);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 16px;
            transition: background-color 0.5s ease, color 0.5s ease;
            min-height: 100vh;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .background-blob {
            position: fixed;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, var(--accent-color) 0%, transparent 60%);
            opacity: 0.1; z-index: -1;
            transition: background 0.5s ease;
        }

        /* HEADER */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .lang-switch {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 4px;
            display: flex;
            box-shadow: var(--shadow);
            border: 1px solid var(--card-border);
        }

        .lang-btn {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
            color: var(--text-color);
            opacity: 0.6;
        }
        .lang-btn.active {
            background: var(--text-color);
            color: var(--bg-color);
            opacity: 1;
        }

        .date-tabs {
            display: flex;
            gap: 8px;
            flex-grow: 1;
            justify-content: center;
            margin-right: 10px;
        }
        .date-tab {
            background: transparent;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0.7;
            cursor: pointer;
            white-space: nowrap;
            transition: 0.2s;
        }
        .date-tab.active {
            background: var(--text-color);
            color: var(--bg-color);
            opacity: 1;
            font-weight: 800;
            transform: scale(1.05);
        }

        /* QUEUES */
        .queue-container-wrapper { margin: 0 -16px 20px -16px; padding: 0 16px; }
        .queue-selector {
            display: flex; gap: 10px; overflow-x: auto; padding: 5px 5px 15px 5px;
            scrollbar-width: none; 
        }
        .queue-selector::-webkit-scrollbar { display: none; }

        .queue-btn {
            flex: 0 0 auto;
            background: var(--card-bg);
            color: var(--text-color);
            padding: 12px 18px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 15px;
            cursor: pointer;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .queue-btn.active {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }

        /* HERO CARD */
        .hero-card {
            background: var(--card-bg);
            border-radius: 28px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
        }
        .status-icon { font-size: 64px; display: block; animation: float 3s ease-in-out infinite; margin-bottom: 10px; }
        .status-title { font-size: 28px; font-weight: 900; margin: 0; line-height: 1.1; }
        .countdown { font-size: 18px; margin-top: 12px; font-weight: 700; font-variant-numeric: tabular-nums; opacity: 0.9; }
        .update-info { font-size: 11px; margin-top: 15px; opacity: 0.4; font-weight: 600; }

        /* TIMELINE */
        .timeline-container { position: relative; padding-top: 10px; margin-bottom: 25px; }
        .timeline-bar {
            display: flex; height: 44px; border-radius: 14px; overflow: hidden;
            border: 2px solid var(--card-bg); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .hour-block { flex: 1; height: 100%; }
        .bg-on { background: linear-gradient(180deg, #4cd964 0%, #34a849 100%); }
        .bg-off { background: linear-gradient(180deg, #ff3b30 0%, #d6271c 100%); }

        .current-time-marker {
            position: absolute; top: 4px; bottom: -6px; width: 4px;
            background: var(--text-color); border-radius: 4px; z-index: 10;
            box-shadow: 0 0 10px var(--text-color); transition: left 1s linear;
        }
        .time-labels {
            display: flex; justify-content: space-between;
            font-size: 11px; opacity: 0.6; margin-top: 8px; font-weight: 700;
        }

        /* STATS */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-box {
            background: var(--card-bg); border-radius: 20px; padding: 15px; text-align: center;
            border: 1px solid var(--card-border); box-shadow: var(--shadow);
        }
        .stat-label { font-size: 12px; opacity: 0.7; font-weight: 700; margin-bottom: 5px; display: block; }
        .stat-value { font-size: 20px; font-weight: 900; }
        .stat-box.on .stat-value { color: var(--on-color); }
        .stat-box.off .stat-value { color: var(--off-color); }

        /* LIST DETAILS */
        .details-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 5px 0;
            box-shadow: var(--shadow);
            border: 1px solid var(--card-border);
            overflow: hidden;
            margin-bottom: 30px;
        }
        .list-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .list-row:last-child { border-bottom: none; }
        .row-time { font-size: 17px; font-weight: 800; font-variant-numeric: tabular-nums; }
        
        .row-status {
            font-size: 13px; font-weight: 800; padding: 6px 12px; border-radius: 10px;
            display: flex; align-items: center; gap: 6px;
        }
        .status-badge-on { background: rgba(76, 217, 100, 0.15); color: var(--on-color); }
        .status-badge-off { background: rgba(255, 59, 48, 0.15); color: var(--off-color); }

        .loading { text-align: center; padding: 60px; opacity: 0.6; font-weight: 700; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    </style>
</head>
<body>

    <div class="background-blob"></div>

    <div class="top-bar">
        <div class="date-tabs" id="date-tabs"></div>
        <div class="lang-switch">
            <div class="lang-btn active" onclick="setLanguage('uk')" id="btn-uk">UA</div>
            <div class="lang-btn" onclick="setLanguage('ru')" id="btn-ru">RU</div>
        </div>
    </div>

    <div class="queue-container-wrapper">
        <div class="queue-selector" id="queue-container"></div>
    </div>

    <div class="hero-card" id="hero-card" style="display:none;">
        <div class="status-icon" id="status-icon">‚ö°</div>
        <div class="status-title" id="status-text">...</div>
        <div class="countdown" id="countdown-text">...</div>
        <div class="update-info" id="update-time"></div>
    </div>

    <div class="timeline-container" id="timeline-area" style="display:none;">
        <div class="timeline-bar" id="visual-schedule"></div>
        <div class="current-time-marker" id="time-marker"></div>
        <div class="time-labels"><span>00</span><span>06</span><span>12</span><span>18</span><span>24</span></div>
    </div>

    <div class="stats-grid" id="stats-area" style="display:none;">
        <div class="stat-box on">
            <span class="stat-label" id="label-on">–°–≤—ñ—Ç–ª–æ —î</span>
            <div class="stat-value" id="val-on">0 –≥–æ–¥</div>
        </div>
        <div class="stat-box off">
            <span class="stat-label" id="label-off">–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞</span>
            <div class="stat-value" id="val-off">0 –≥–æ–¥</div>
        </div>
    </div>

    <div class="details-card" id="details-list" style="display:none;">
        </div>

    <div class="loading" id="loading">...</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const translations = {
            uk: {
                loading: "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...",
                no_data: "–ì—Ä–∞—Ñ—ñ–∫—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î ü§∑‚Äç‚ôÇÔ∏è",
                select_queue: "–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É",
                light_on: "–°–í–Ü–¢–õ–û –Ñ",
                light_off: "–°–í–Ü–¢–õ–ê –ù–ï–ú–ê",
                until_off: "–í–∏–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑:",
                until_on: "–í–≤—ñ–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑:",
                updated: "–û–Ω–æ–≤–ª–µ–Ω–æ:",
                label_on: "–°–≤—ñ—Ç–ª–æ —î (—Ä–∞–∑–æ–º)",
                label_off: "–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞ (—Ä–∞–∑–æ–º)",
                hr: "–≥–æ–¥", min: "—Ö–≤", sec: "—Å"
            },
            ru: {
                loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
                no_data: "–ì—Ä–∞—Ñ–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç ü§∑‚Äç‚ôÇÔ∏è",
                select_queue: "–í—ã–±–µ—Ä–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å",
                light_on: "–°–í–ï–¢ –ï–°–¢–¨",
                light_off: "–°–í–ï–¢–ê –ù–ï–¢",
                until_off: "–û—Ç–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑:",
                until_on: "–í–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑:",
                updated: "–û–±–Ω–æ–≤–ª–µ–Ω–æ:",
                label_on: "–°–≤–µ—Ç –µ—Å—Ç—å (–≤—Å–µ–≥–æ)",
                label_off: "–°–≤–µ—Ç–∞ –Ω–µ—Ç (–≤—Å–µ–≥–æ)",
                hr: "—á", min: "–º–∏–Ω", sec: "—Å"
            }
        };

        const monthMapping = {
            "–°–Ü–ß–ù–Ø": "–Ø–ù–í–ê–†–Ø", "–õ–Æ–¢–û–ì–û": "–§–ï–í–†–ê–õ–Ø", "–ë–ï–†–ï–ó–ù–Ø": "–ú–ê–†–¢–ê", "–ö–í–Ü–¢–ù–Ø": "–ê–ü–†–ï–õ–Ø", "–¢–†–ê–í–ù–Ø": "–ú–ê–Ø", "–ß–ï–†–í–ù–Ø": "–ò–Æ–ù–Ø",
            "–õ–ò–ü–ù–Ø": "–ò–Æ–õ–Ø", "–°–ï–†–ü–ù–Ø": "–ê–í–ì–£–°–¢–ê", "–í–ï–†–ï–°–ù–Ø": "–°–ï–ù–¢–Ø–ë–†–Ø", "–ñ–û–í–¢–ù–Ø": "–û–ö–¢–Ø–ë–†–Ø", "–õ–ò–°–¢–û–ü–ê–î–ê": "–ù–û–Ø–ë–†–Ø", "–ì–†–£–î–ù–Ø": "–î–ï–ö–ê–ë–†–Ø"
        };

        let currentLang = localStorage.getItem('appLang') || 'uk';
        let schedulesData = [];
        let activeSchedule = null;
        let activeQueue = localStorage.getItem('myQueue');

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('appLang', lang);
            
            document.getElementById('btn-uk').classList.toggle('active', lang === 'uk');
            document.getElementById('btn-ru').classList.toggle('active', lang === 'ru');
            
            document.getElementById('label-on').innerText = translations[lang].label_on;
            document.getElementById('label-off').innerText = translations[lang].label_off;

            if (schedulesData.length > 0) {
                renderDateTabs();
                const currentIdx = schedulesData.indexOf(activeSchedule);
                selectSchedule(currentIdx !== -1 ? currentIdx : 0);
                
                if (!activeQueue) {
                    document.getElementById('status-text').innerText = translations[lang].select_queue;
                } else {
                    updateStats();
                    renderDetailsList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ (—Ç–µ–∫—Å—Ç—ã)
                }
            } else {
                document.getElementById('loading').innerText = translations[lang].loading;
            }
        }

        function translateDate(dateStr) {
            if (currentLang === 'uk') return dateStr;
            let newStr = dateStr;
            for (const [ua, ru] of Object.entries(monthMapping)) {
                if (newStr.includes(ua)) {
                    newStr = newStr.replace(ua, ru);
                    break;
                }
            }
            return newStr;
        }

        async function init() {
            setLanguage(currentLang);
            try {
                const resp = await fetch('schedule.json?v=' + Date.now());
                const json = await resp.json();
                schedulesData = json.schedules;
                document.getElementById('loading').style.display = 'none';

                if (!schedulesData || schedulesData.length === 0) {
                    document.getElementById('loading').innerText = translations[currentLang].no_data;
                    document.getElementById('loading').style.display = 'block';
                    return;
                }

                renderDateTabs();
                selectSchedule(0);
                renderQueueButtons();

                if (activeQueue) selectQueue(activeQueue);
                else {
                    document.getElementById('hero-card').style.display = 'block';
                    document.getElementById('status-icon').innerText = 'üëÜ';
                    document.getElementById('status-text').innerText = translations[currentLang].select_queue;
                }
                setInterval(updateRealtimeStatus, 1000);
            } catch (e) {
                console.error(e);
            }
        }

        function renderDateTabs() {
            const container = document.getElementById('date-tabs');
            container.innerHTML = '';
            schedulesData.forEach((sch, idx) => {
                const btn = document.createElement('div');
                btn.className = `date-tab ${activeSchedule === sch ? 'active' : ''}`;
                btn.innerText = translateDate(sch.date);
                btn.onclick = () => selectSchedule(idx);
                container.appendChild(btn);
            });
        }

        function selectSchedule(idx) {
            activeSchedule = schedulesData[idx];
            renderDateTabs();
            document.getElementById('update-time').innerText = 
                `${translations[currentLang].updated} ${activeSchedule.updated_at}`;
            if (activeQueue) {
                drawGraph();
                updateStats();
                renderDetailsList(); // –†–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫
                updateRealtimeStatus();
            }
        }

        function renderQueueButtons() {
            const container = document.getElementById('queue-container');
            const queues = ["1.1", "1.2", "2.1", "2.2", "3.1", "3.2", "4.1", "4.2", "5.1", "5.2", "6.1", "6.2"];
            container.innerHTML = '';
            queues.forEach(q => {
                const btn = document.createElement('div');
                btn.className = `queue-btn ${activeQueue === q ? 'active' : ''}`;
                btn.innerText = q;
                btn.onclick = () => selectQueue(q);
                container.appendChild(btn);
            });
        }

        function selectQueue(q) {
            activeQueue = q;
            localStorage.setItem('myQueue', q);
            renderQueueButtons();
            document.getElementById('hero-card').style.display = 'block';
            document.getElementById('timeline-area').style.display = 'block';
            document.getElementById('stats-area').style.display = 'grid';
            document.getElementById('details-list').style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
            
            drawGraph();
            updateStats();
            renderDetailsList();
            updateRealtimeStatus();
        }

        function drawGraph() {
            const container = document.getElementById('visual-schedule');
            container.innerHTML = '';
            const dayMap = getDayMap();
            let currentStatus = dayMap[0];
            let blockStart = 0;
            for (let i = 1; i <= 1440; i++) {
                if (i === 1440 || dayMap[i] !== currentStatus) {
                    const width = ((i - blockStart) / 1440) * 100;
                    const div = document.createElement('div');
                    div.className = 'hour-block ' + (currentStatus ? 'bg-on' : 'bg-off');
                    div.style.flexBasis = width + '%';
                    container.appendChild(div);
                    currentStatus = dayMap[i];
                    blockStart = i;
                }
            }
        }

        function updateStats() {
            const outages = activeSchedule.queues[activeQueue] || [];
            let totalOff = 0;
            outages.forEach(o => {
                let start = timeToMins(o.start), end = timeToMins(o.end);
                if (end === 0) end = 1440;
                totalOff += (end - start);
            });
            const t = translations[currentLang];
            document.getElementById('val-off').innerText = formatDuration(totalOff, t);
            document.getElementById('val-on').innerText = formatDuration(1440 - totalOff, t);
        }

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–ü–ò–°–ö–ê ---
        function renderDetailsList() {
            const container = document.getElementById('details-list');
            container.innerHTML = '';
            const t = translations[currentLang];
            
            const dayMap = getDayMap();
            let segments = [];
            let currentStatus = dayMap[0];
            let start = 0;

            for (let i = 1; i <= 1440; i++) {
                if (i === 1440 || dayMap[i] !== currentStatus) {
                    segments.push({ status: currentStatus, start: start, end: i });
                    currentStatus = dayMap[i];
                    start = i;
                }
            }

            segments.forEach(seg => {
                const row = document.createElement('div');
                row.className = 'list-row';
                
                const timeText = `${minsToTime(seg.start)} - ${minsToTime(seg.end)}`;
                const statusClass = seg.status ? 'status-badge-on' : 'status-badge-off';
                const statusText = seg.status ? t.light_on : t.light_off;
                const icon = seg.status ? 'üü¢' : 'üî¥';

                row.innerHTML = `
                    <div class="row-time">${timeText}</div>
                    <div class="row-status ${statusClass}">${icon} ${statusText}</div>
                `;
                container.appendChild(row);
            });
        }

        function updateRealtimeStatus() {
            if (!activeQueue || !activeSchedule) return;
            const t = translations[currentLang];
            const now = new Date();
            const curMins = (now.getHours() * 60) + now.getMinutes();
            const curSecs = curMins * 60 + now.getSeconds();
            
            document.getElementById('time-marker').style.left = (curMins / 1440) * 100 + '%';

            // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            const dayMap = getDayMap();
            const currentStatus = dayMap[curMins] !== undefined ? dayMap[curMins] : true; // –∑–∞—â–∏—Ç–∞
            let nextChange = 1440;
            
            for (let i = curMins + 1; i < 1440; i++) {
                if (dayMap[i] !== currentStatus) {
                    nextChange = i;
                    break;
                }
            }

            const diffSec = (nextChange * 60) - curSecs;
            const h = Math.floor(diffSec / 3600);
            const m = Math.floor((diffSec % 3600) / 60);
            const s = Math.floor(diffSec % 60);
            const pad = n => n.toString().padStart(2, '0');
            const timeStr = diffSec > 0 ? `${pad(h)}:${pad(m)}:${pad(s)}` : "00:00:00";

            const icon = document.getElementById('status-icon');
            const title = document.getElementById('status-text');
            const count = document.getElementById('countdown-text');

            if (currentStatus) {
                document.body.classList.remove('dark-mode');
                icon.innerText = '‚òÄÔ∏è';
                title.innerText = t.light_on;
                title.style.color = '#333';
                count.innerText = `${t.until_off} ${timeStr}`;
            } else {
                document.body.classList.add('dark-mode');
                icon.innerText = 'üïØÔ∏è';
                title.innerText = t.light_off;
                title.style.color = '#ff5e62';
                count.innerText = `${t.until_on} ${timeStr}`;
            }
        }

        // Helpers
        function getDayMap() {
            const outages = activeSchedule.queues[activeQueue] || [];
            let map = new Array(1440).fill(true);
            outages.forEach(o => {
                let s = timeToMins(o.start), e = timeToMins(o.end);
                if (e === 0) e = 1440;
                for(let i=s; i<e; i++) if(i < 1440) map[i] = false;
            });
            return map;
        }
        function timeToMins(s) { const p = s.split(':'); return parseInt(p[0])*60 + parseInt(p[1]); }
        function minsToTime(m) { 
            if(m === 1440) return "24:00";
            const h = Math.floor(m/60).toString().padStart(2,'0');
            const mn = (m%60).toString().padStart(2,'0');
            return `${h}:${mn}`;
        }
        function formatDuration(m, t) {
            const h = Math.floor(m/60), mn = m%60;
            if(h>0 && mn>0) return `${h}${t.hr} ${mn}${t.min}`;
            if(h>0) return `${h} ${t.hr}`;
            return `${mn} ${t.min}`;
        }

        init();
    </script>
</body>
</html>
