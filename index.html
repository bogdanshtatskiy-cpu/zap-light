<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–ü–í –ó–∞–ø–æ—Ä—ñ–∂–∂—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f4f6f8;
            --text: #1a1a1a;
            --card: #ffffff;
            --accent: #3390ec; /* Telegram Blue */
            --border: rgba(0,0,0,0.08);
            --on: #34c759;
            --off: #ff3b30;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        body.dark-mode {
            --bg: #0f0f0f;
            --text: #ffffff;
            --card: #1c1c1e;
            --accent: #0a84ff;
            --border: rgba(255,255,255,0.1);
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Nunito', sans-serif;
            margin: 0; padding: 16px;
            min-height: 100vh;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: 0.3s;
        }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .app-title { font-size: 22px; font-weight: 800; margin: 0; }
        .lang-switch {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 12px; padding: 3px; display: flex;
        }
        .lang-btn {
            padding: 4px 10px; font-size: 12px; font-weight: 800;
            border-radius: 9px; opacity: 0.5; cursor: pointer; transition: 0.2s;
        }
        .lang-btn.active { background: var(--text); color: var(--bg); opacity: 1; }

        /* DATE TABS (Compact) */
        .date-container {
            display: flex; gap: 8px; margin-bottom: 20px;
            justify-content: center; /* –¶–µ–Ω—Ç—Ä */
        }
        .date-tab {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: 14px;
            font-size: 13px; font-weight: 700;
            cursor: pointer; opacity: 0.6;
            transition: 0.2s;
            box-shadow: var(--shadow);
            flex: 1; /* –†–∞—Å—Ç—è–Ω—É—Ç—å —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ */
            text-align: center;
            max-width: 120px;
        }
        .date-tab.active {
            opacity: 1;
            border-color: var(--accent);
            background: var(--accent);
            color: white;
            transform: translateY(-2px);
        }

        /* QUEUES */
        .queue-scroll {
            overflow-x: auto; margin: 0 -16px 25px -16px; padding: 0 16px 10px 16px;
            display: flex; gap: 8px; scrollbar-width: none;
        }
        .queue-btn {
            flex: 0 0 auto;
            background: var(--card); color: var(--text);
            border: 1px solid var(--border);
            padding: 12px 18px; border-radius: 14px;
            font-weight: 800; font-size: 15px;
            box-shadow: var(--shadow);
            transition: 0.2s;
        }
        .queue-btn.active {
            background: var(--text); color: var(--bg);
            border-color: var(--text); transform: scale(1.05);
        }

        /* HERO STATUS */
        .hero {
            background: var(--card); border-radius: 24px;
            padding: 25px; text-align: center;
            box-shadow: var(--shadow); margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        .icon { font-size: 48px; margin-bottom: 10px; display: block; animation: float 3s infinite ease-in-out; }
        .status-main { font-size: 24px; font-weight: 900; margin-bottom: 5px; }
        .timer { font-size: 16px; font-weight: 700; opacity: 0.7; font-variant-numeric: tabular-nums; }
        .last-update { font-size: 11px; margin-top: 15px; opacity: 0.4; font-weight: 600; }

        /* VISUAL BAR */
        .bar-wrap { position: relative; height: 40px; margin-bottom: 25px; }
        .bar {
            display: flex; height: 100%; border-radius: 12px; overflow: hidden;
            border: 2px solid var(--card);
        }
        .chunk { flex: 1; height: 100%; }
        .chunk.on { background: var(--on); }
        .chunk.off { background: var(--off); }
        
        .marker {
            position: absolute; top: -4px; bottom: -4px; width: 4px;
            background: var(--text); border-radius: 4px; z-index: 5;
            transition: left 1s linear;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .labels {
            display: flex; justify-content: space-between;
            font-size: 10px; font-weight: 700; opacity: 0.5; margin-top: 6px;
        }

        /* STATS */
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card {
            background: var(--card); padding: 12px; border-radius: 16px;
            text-align: center; border: 1px solid var(--border);
        }
        .stat-label { font-size: 11px; font-weight: 700; opacity: 0.5; display: block; margin-bottom: 4px; }
        .stat-val { font-size: 18px; font-weight: 900; }
        .stat-val.on { color: var(--on); }
        .stat-val.off { color: var(--off); }

        .loader { text-align: center; padding: 50px; font-weight: 800; opacity: 0.5; }

        @keyframes float { 0%, 100% {transform:translateY(0)} 50% {transform:translateY(-6px)} }
    </style>
</head>
<body>

    <div class="header">
        <div class="app-title">‚ö° –ì–ü–í</div>
        <div class="lang-switch">
            <div class="lang-btn active" id="btn-uk" onclick="setLang('uk')">UA</div>
            <div class="lang-btn" id="btn-ru" onclick="setLang('ru')">RU</div>
        </div>
    </div>

    <div class="date-container" id="dates"></div>

    <div class="queue-scroll" id="queues"></div>

    <div class="hero" id="hero" style="display:none">
        <span class="icon" id="icon">‚ö°</span>
        <div class="status-main" id="status">...</div>
        <div class="timer" id="timer">...</div>
        <div class="last-update" id="updated"></div>
    </div>

    <div class="bar-wrap" id="bar-wrap" style="display:none">
        <div class="bar" id="visual"></div>
        <div class="marker" id="marker"></div>
        <div class="labels"><span>00</span><span>06</span><span>12</span><span>18</span><span>24</span></div>
    </div>

    <div class="stats" id="stats" style="display:none">
        <div class="stat-card">
            <span class="stat-label" id="lbl-on">–°–≤—ñ—Ç–ª–æ —î</span>
            <div class="stat-val on" id="val-on">-</div>
        </div>
        <div class="stat-card">
            <span class="stat-label" id="lbl-off">–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞</span>
            <div class="stat-val off" id="val-off">-</div>
        </div>
    </div>

    <div class="loader" id="loader">...</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        const UA_MONTHS = ["–°–Ü–ß–ù–Ø", "–õ–Æ–¢–û–ì–û", "–ë–ï–†–ï–ó–ù–Ø", "–ö–í–Ü–¢–ù–Ø", "–¢–†–ê–í–ù–Ø", "–ß–ï–†–í–ù–Ø", "–õ–ò–ü–ù–Ø", "–°–ï–†–ü–ù–Ø", "–í–ï–†–ï–°–ù–Ø", "–ñ–û–í–¢–ù–Ø", "–õ–ò–°–¢–û–ü–ê–î–ê", "–ì–†–£–î–ù–Ø"];
        const RU_MONTHS = ["–Ø–ù–í–ê–†–Ø", "–§–ï–í–†–ê–õ–Ø", "–ú–ê–†–¢–ê", "–ê–ü–†–ï–õ–Ø", "–ú–ê–Ø", "–ò–Æ–ù–Ø", "–ò–Æ–õ–Ø", "–ê–í–ì–£–°–¢–ê", "–°–ï–ù–¢–Ø–ë–†–Ø", "–û–ö–¢–Ø–ë–†–Ø", "–ù–û–Ø–ë–†–Ø", "–î–ï–ö–ê–ë–†–Ø"];
        
        let DATA = [];
        let currentSchedule = null;
        let selectedQueue = localStorage.getItem('queue');
        let lang = localStorage.getItem('lang') || 'uk';

        const T = {
            uk: { load: "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...", nodata: "–î–∞–Ω–∏—Ö –Ω–µ–º–∞—î", choose: "–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É", on: "–°–í–Ü–¢–õ–û –Ñ", off: "–°–í–Ü–¢–õ–ê –ù–ï–ú–ê", in_on: "–í–≤—ñ–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑:", in_off: "–í–∏–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑:", upd: "–û–Ω–æ–≤–ª–µ–Ω–æ:", h: "–≥–æ–¥", m: "—Ö–≤", lbl_on: "–°–≤—ñ—Ç–ª–æ —î", lbl_off: "–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞" },
            ru: { load: "–ó–∞–≥—Ä—É–∑–∫–∞...", nodata: "–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç", choose: "–í—ã–±–µ—Ä–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å", on: "–°–í–ï–¢ –ï–°–¢–¨", off: "–°–í–ï–¢–ê –ù–ï–¢", in_on: "–í–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑:", in_off: "–û—Ç–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑:", upd: "–û–±–Ω–æ–≤–ª–µ–Ω–æ:", h: "—á", m: "–º–∏–Ω", lbl_on: "–°–≤–µ—Ç –µ—Å—Ç—å", lbl_off: "–°–≤–µ—Ç–∞ –Ω–µ—Ç" }
        };

        // --- –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---

        async function init() {
            setLang(lang);
            document.getElementById('loader').innerText = T[lang].load;

            try {
                const res = await fetch('schedule.json?v=' + Date.now());
                const json = await res.json();
                DATA = json.schedules; // –û–∂–∏–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –¥–∞—Ç–µ (–≤—á–µ—Ä–∞ -> —Å–µ–≥–æ–¥–Ω—è -> –∑–∞–≤—Ç—Ä–∞)

                if (!DATA || DATA.length === 0) {
                    document.getElementById('loader').innerText = T[lang].nodata;
                    return;
                }

                document.getElementById('loader').style.display = 'none';
                
                renderQueues();
                
                // –ê–í–¢–û-–í–´–ë–û–† –î–ê–¢–´ (–°–ï–ì–û–î–ù–Ø)
                // 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –ø–æ –ö–∏–µ–≤—É
                const kievDate = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Kiev"}));
                const todayDay = kievDate.getDate();
                const todayMonthIdx = kievDate.getMonth(); // 0-11

                // 2. –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –¥–∞–Ω–Ω—ã—Ö
                let activeIndex = -1;
                DATA.forEach((item, idx) => {
                    // item.date = "10 –ì–†–£–î–ù–Ø"
                    const parts = item.date.split(' ');
                    const d = parseInt(parts[0]);
                    const mName = parts[1].toUpperCase();
                    const mIdx = UA_MONTHS.indexOf(mName);

                    if (d === todayDay && mIdx === todayMonthIdx) {
                        activeIndex = idx;
                    }
                });

                // 3. –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç, –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π (—Å–∞–º—ã–π —Å–≤–µ–∂–∏–π)
                if (activeIndex === -1) activeIndex = DATA.length - 1;

                renderDates(activeIndex);
                selectDate(activeIndex);

                if (selectedQueue) selectQueue(selectedQueue);
                else {
                    document.getElementById('hero').style.display = 'block';
                    document.getElementById('status').innerText = T[lang].choose;
                }

                setInterval(tick, 1000);

            } catch (e) {
                console.error(e);
                document.getElementById('loader').innerText = "Error";
            }
        }

        // --- –†–ï–ù–î–ï–† ---

        function renderDates(activeIdx) {
            const el = document.getElementById('dates');
            el.innerHTML = '';
            DATA.forEach((item, idx) => {
                const btn = document.createElement('div');
                btn.className = `date-tab ${idx === activeIdx ? 'active' : ''}`;
                // –ü–µ—Ä–µ–≤–æ–¥ –¥–∞—Ç—ã
                let label = item.date;
                if (lang === 'ru') {
                    const parts = item.date.split(' ');
                    const mIdx = UA_MONTHS.indexOf(parts[1].toUpperCase());
                    if (mIdx !== -1) label = `${parts[0]} ${RU_MONTHS[mIdx]}`;
                }
                btn.innerText = label;
                btn.onclick = () => {
                    selectDate(idx);
                    renderDates(idx); // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
                };
                el.appendChild(btn);
            });
        }

        function renderQueues() {
            const el = document.getElementById('queues');
            const qs = ["1.1", "1.2", "2.1", "2.2", "3.1", "3.2", "4.1", "4.2", "5.1", "5.2", "6.1", "6.2"];
            el.innerHTML = '';
            qs.forEach(q => {
                const btn = document.createElement('div');
                btn.className = `queue-btn ${q === selectedQueue ? 'active' : ''}`;
                btn.innerText = q;
                btn.onclick = () => selectQueue(q);
                el.appendChild(btn);
            });
        }

        // --- –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê ---

        function selectDate(idx) {
            currentSchedule = DATA[idx];
            document.getElementById('updated').innerText = `${T[lang].upd} ${currentSchedule.updated_at}`;
            if (selectedQueue) updateView();
        }

        function selectQueue(q) {
            selectedQueue = q;
            localStorage.setItem('queue', q);
            
            // –û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∞—Å—Å –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.queue-btn').forEach(b => {
                b.classList.toggle('active', b.innerText === q);
            });

            document.getElementById('hero').style.display = 'block';
            document.getElementById('bar-wrap').style.display = 'block';
            document.getElementById('stats').style.display = 'grid';
            
            updateView();
        }

        function setLang(l) {
            lang = l;
            localStorage.setItem('lang', l);
            document.getElementById('btn-uk').className = `lang-btn ${l==='uk'?'active':''}`;
            document.getElementById('btn-ru').className = `lang-btn ${l==='ru'?'active':''}`;
            document.getElementById('lbl-on').innerText = T[l].lbl_on;
            document.getElementById('lbl-off').innerText = T[l].lbl_off;
            if(DATA.length) {
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –¥–∞—Ç—ã –∏ —Ç–µ–∫—Å—Ç—ã
                const idx = DATA.indexOf(currentSchedule);
                renderDates(idx !== -1 ? idx : 0);
                if (!selectedQueue) document.getElementById('status').innerText = T[l].choose;
                else updateView();
            }
        }

        // --- –Ø–î–†–û –û–¢–†–ò–°–û–í–ö–ò ---

        function updateView() {
            if (!currentSchedule || !selectedQueue) return;

            // 1. –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
            const timeline = document.getElementById('visual');
            timeline.innerHTML = '';
            const map = getDayMap();
            
            let current = map[0];
            let start = 0;
            for(let i=1; i<=1440; i++) {
                if(i===1440 || map[i] !== current) {
                    const d = document.createElement('div');
                    d.className = `chunk ${current ? 'on' : 'off'}`;
                    d.style.flexBasis = ((i-start)/1440*100) + '%';
                    timeline.appendChild(d);
                    current = map[i];
                    start = i;
                }
            }

            // 2. –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            let offMins = 0;
            const outages = currentSchedule.queues[selectedQueue] || [];
            outages.forEach(o => {
                let s = timeToMins(o.start), e = timeToMins(o.end);
                if(e===0) e=1440;
                offMins += (e-s);
            });
            document.getElementById('val-off').innerText = fmtDur(offMins);
            document.getElementById('val-on').innerText = fmtDur(1440 - offMins);

            tick(); // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å—Ä–∞–∑—É
        }

        // --- –¢–ê–ô–ú–ï–† –ò –°–¢–ê–¢–£–° ---

        function tick() {
            if (!currentSchedule || !selectedQueue) return;

            // –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ü–û –ö–ò–ï–í–£
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Kiev"}));
            const curMins = now.getHours() * 60 + now.getMinutes();
            const curSecs = curMins * 60 + now.getSeconds();

            // –î–≤–∏–≥–∞–µ–º –º–∞—Ä–∫–µ—Ä (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ - —ç—Ç–æ –°–ï–ì–û–î–ù–Ø)
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–º–æ—Ç—Ä–∏–º –ª–∏ –º—ã –Ω–∞ "—Å–µ–≥–æ–¥–Ω—è"
            const parts = currentSchedule.date.split(' '); // "10 –ì–†–£–î–ù–Ø"
            const d = parseInt(parts[0]);
            const mIdx = UA_MONTHS.indexOf(parts[1].toUpperCase());
            
            const isToday = (d === now.getDate() && mIdx === now.getMonth());
            
            const marker = document.getElementById('marker');
            if (isToday) {
                marker.style.display = 'block';
                marker.style.left = (curMins / 1440 * 100) + '%';
            } else {
                marker.style.display = 'none';
                // –ï—Å–ª–∏ —Å–º–æ—Ç—Ä–∏–º –Ω–∞ –∑–∞–≤—Ç—Ä–∞/–≤—á–µ—Ä–∞ - —Ç–∞–π–º–µ—Ä –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º (–∏–ª–∏ –ø–∏—à–µ–º "–≠—Ç–æ –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞")
                // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ—Å—Ç–∞–≤–∏–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ 00:00 –∏–ª–∏ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏?
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –≤–∏–¥–µ—Ç—å, –∫–æ–≥–¥–∞ –æ—Ç–∫–ª—é—á–∞—Ç –ó–ê–í–¢–†–ê. 
                // –ü—É—Å—Ç—å —Ç–∞–π–º–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "–Ω–∞ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫" –Ω–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã.
            }

            // –°—Ç–∞—Ç—É—Å
            const map = getDayMap();
            const isLight = map[curMins] !== undefined ? map[curMins] : true;
            
            // –ò—â–µ–º —Å–ª–µ–¥—É—é—â–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            let nextChange = 1440;
            for(let i = curMins + 1; i < 1440; i++) {
                if(map[i] !== isLight) { nextChange = i; break; }
            }

            const diffSec = (nextChange * 60) - curSecs;
            const h = Math.floor(diffSec / 3600);
            const m = Math.floor((diffSec % 3600) / 60);
            const s = Math.floor(diffSec % 60);
            const timeStr = `${pad(h)}:${pad(m)}:${pad(s)}`;

            const body = document.body;
            const icon = document.getElementById('icon');
            const st = document.getElementById('status');
            const tm = document.getElementById('timer');

            if (isLight) {
                body.classList.remove('dark-mode');
                icon.innerText = '‚òÄÔ∏è';
                st.innerText = T[lang].on;
                st.style.color = '#333';
                tm.innerText = `${T[lang].in_off} ${timeStr}`;
            } else {
                body.classList.add('dark-mode');
                icon.innerText = 'üïØÔ∏è';
                st.innerText = T[lang].off;
                st.style.color = '#ff3b30';
                tm.innerText = `${T[lang].in_on} ${timeStr}`;
            }
            
            if (!isToday && diffSec < 0) tm.innerText = ""; // –°–∫—Ä—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –¥–µ–Ω—å –ø—Ä–æ—à–µ–ª
        }

        // –•–ï–õ–ü–ï–†–´
        function getDayMap() {
            const map = new Array(1440).fill(true);
            const list = currentSchedule.queues[selectedQueue] || [];
            list.forEach(o => {
                let s = timeToMins(o.start), e = timeToMins(o.end);
                if(e===0) e=1440;
                for(let i=s; i<e; i++) if(i<1440) map[i] = false;
            });
            return map;
        }
        function timeToMins(s) { const p=s.split(':'); return parseInt(p[0])*60 + parseInt(p[1]); }
        function fmtDur(m) {
            const h = Math.floor(m/60), mn = m%60;
            if(h>0 && mn>0) return `${h}${T[lang].h} ${mn}${T[lang].m}`;
            if(h>0) return `${h} ${T[lang].h}`;
            return `${mn} ${T[lang].m}`;
        }
        function pad(n) { return n.toString().padStart(2,'0'); }

        init();
    </script>
</body>
</html>
