<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–≤—ñ—Ç–ª–æ –ó–∞–ø–æ—Ä—ñ–∂–∂—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±—É–¥—É—Ç –º–µ–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JS */
            --bg-color: #f0f8ff;
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.8);
            --accent-color: #4facfe;
            --status-bg: #e6f7ff;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            
            --on-color: #4cd964;  /* –ó–µ–ª–µ–Ω—ã–π */
            --off-color: #ff3b30; /* –ö—Ä–∞—Å–Ω—ã–π */
            --gray-color: #d1d1d6;
        }

        /* –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê (–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∫–ª–∞—Å—Å–æ–º .dark-mode) */
        body.dark-mode {
            --bg-color: #121212;
            --text-color: #ffffff;
            --card-bg: rgba(30, 30, 30, 0.8);
            --accent-color: #ff9500;
            --status-bg: #2c2c2c;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 16px;
            transition: background-color 0.8s ease, color 0.8s ease;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —Ñ–æ–Ω–∞ */
        .background-blob {
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--accent-color) 0%, transparent 60%);
            opacity: 0.1;
            z-index: -1;
            transition: background 0.8s ease;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .date-badge {
            display: inline-block;
            background: var(--card-bg);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            box-shadow: var(--shadow);
            margin-bottom: 5px;
        }
        .update-time { font-size: 12px; opacity: 0.6; }

        /* –ö–Ω–æ–ø–∫–∏ –æ—á–µ—Ä–µ–¥–µ–π */
        .queue-selector {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 20px;
            scrollbar-width: none; /* –°–∫—Ä—ã—Ç—å —Å–∫—Ä–æ–ª–ª */
        }
        .queue-btn {
            flex: 0 0 auto;
            background: var(--card-bg);
            border: 2px solid transparent;
            color: var(--text-color);
            padding: 10px 18px;
            border-radius: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: var(--shadow);
        }
        .queue-btn.active {
            border-color: var(--accent-color);
            background: var(--status-bg);
            transform: scale(1.05);
        }

        /* –ì–õ–ê–í–ù–ê–Ø –ö–ê–†–¢–û–ß–ö–ê –°–¢–ê–¢–£–°–ê */
        .hero-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: 0.5s;
        }

        .status-icon {
            font-size: 60px;
            margin-bottom: 10px;
            display: block;
            animation: float 3s ease-in-out infinite;
        }

        .status-title {
            font-size: 28px;
            font-weight: 900;
            margin: 0;
            line-height: 1.2;
        }

        .countdown {
            font-size: 16px;
            margin-top: 10px;
            opacity: 0.8;
            font-weight: 600;
        }

        /* –ì–†–ê–§–ò–ö */
        .timeline-container {
            position: relative;
            padding-top: 20px;
        }
        .timeline-bar {
            display: flex;
            height: 40px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            border: 2px solid var(--card-bg);
        }
        .hour-block {
            flex: 1;
            height: 100%;
            position: relative;
        }
        
        /* –¶–≤–µ—Ç–∞ –±–ª–æ–∫–æ–≤ */
        .bg-on { background-color: var(--on-color); }
        .bg-off { background-color: var(--off-color); }

        /* –ú–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ */
        .current-time-marker {
            position: absolute;
            top: -5px;
            bottom: -5px;
            width: 4px;
            background: var(--text-color);
            border-radius: 2px;
            z-index: 10;
            box-shadow: 0 0 10px var(--text-color);
            transition: left 60s linear;
        }

        /* –ü–æ–¥–ø–∏—Å–∏ –≤—Ä–µ–º–µ–Ω–∏ */
        .time-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            opacity: 0.6;
            margin-top: 8px;
            padding: 0 2px;
        }

        .loading { text-align: center; padding: 50px; font-weight: bold; opacity: 0.5; }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        /* –¢–∞–±—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã */
        .date-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .date-tab {
            background: transparent;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0.6;
            cursor: pointer;
        }
        .date-tab.active {
            background: var(--text-color);
            color: var(--bg-color);
            opacity: 1;
        }

    </style>
</head>
<body>

    <div class="background-blob"></div>

    <div class="header">
        <div class="date-tabs" id="date-tabs"></div>
        <div class="date-badge" id="date-header">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        <div class="update-time" id="update-time"></div>
    </div>

    <div class="queue-selector" id="queue-container">
        </div>

    <div class="hero-card" id="hero-card" style="display:none;">
        <div class="status-icon" id="status-icon">‚ùì</div>
        <div class="status-title" id="status-text">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É</div>
        <div class="countdown" id="countdown-text">...</div>
    </div>

    <div class="timeline-container" id="timeline-area" style="display:none;">
        <div class="timeline-bar" id="visual-schedule">
            </div>
        <div class="current-time-marker" id="time-marker"></div>
        
        <div class="time-labels">
            <span>00</span><span>04</span><span>08</span><span>12</span><span>16</span><span>20</span><span>24</span>
        </div>
    </div>

    <div class="loading" id="loading">–®—É–∫–∞—é –≥—Ä–∞—Ñ—ñ–∫...</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let schedulesData = [];
        let activeSchedule = null;
        let activeQueue = localStorage.getItem('myQueue');
        let timerInterval = null;

        // --- 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
        async function init() {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º ?v=... —á—Ç–æ–±—ã –Ω–µ –∫–µ—à–∏—Ä–æ–≤–∞–ª–æ—Å—å
                const resp = await fetch('schedule.json?v=' + Date.now());
                const json = await resp.json();
                
                schedulesData = json.schedules;
                document.getElementById('loading').style.display = 'none';

                if (!schedulesData || schedulesData.length === 0) {
                    document.getElementById('loading').innerText = "–ì—Ä–∞—Ñ—ñ–∫—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î ü§∑‚Äç‚ôÇÔ∏è";
                    document.getElementById('loading').style.display = 'block';
                    return;
                }

                renderDateTabs();
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π (—Å–∞–º—ã–π —Å–≤–µ–∂–∏–π) –≥—Ä–∞—Ñ–∏–∫
                selectSchedule(0); 

                // –†–µ–Ω–¥–µ—Ä–∏–º –∫–Ω–æ–ø–∫–∏ –æ—á–µ—Ä–µ–¥–µ–π
                renderQueueButtons();

                // –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –±—ã–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –≤—ã–±–∏—Ä–∞–µ–º –µ—ë
                if (activeQueue) {
                    selectQueue(activeQueue);
                } else {
                    document.getElementById('hero-card').style.display = 'block';
                    document.getElementById('status-icon').innerText = 'üëÜ';
                    document.getElementById('status-text').innerText = '–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É';
                    document.getElementById('status-text').style.fontSize = '20px';
                }

                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                setInterval(updateRealtimeStatus, 1000);

            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerText = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö";
            }
        }

        // --- 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞—Ç–∞–º–∏ ---
        function renderDateTabs() {
            const container = document.getElementById('date-tabs');
            container.innerHTML = '';
            schedulesData.forEach((sch, idx) => {
                const btn = document.createElement('div');
                btn.className = `date-tab ${idx === 0 ? 'active' : ''}`;
                btn.innerText = sch.date;
                btn.onclick = () => selectSchedule(idx);
                container.appendChild(btn);
            });
        }

        function selectSchedule(idx) {
            activeSchedule = schedulesData[idx];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–∞—Ç—ã
            document.querySelectorAll('.date-tab').forEach((el, i) => {
                el.classList.toggle('active', i === idx);
            });
            document.getElementById('date-header').innerText = activeSchedule.date;
            document.getElementById('update-time').innerText = `–û–Ω–æ–≤–ª–µ–Ω–æ: ${activeSchedule.updated_at}`;

            if (activeQueue) drawGraph(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –Ω–æ–≤–æ–π –¥–∞—Ç—ã
        }

        // --- 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—è–º–∏ ---
        function renderQueueButtons() {
            const container = document.getElementById('queue-container');
            const queues = ["1.1", "1.2", "2.1", "2.2", "3.1", "3.2", "4.1", "4.2", "5.1", "5.2", "6.1", "6.2"];
            
            queues.forEach(q => {
                const btn = document.createElement('div');
                btn.className = 'queue-btn';
                btn.innerText = q;
                btn.onclick = () => selectQueue(q);
                btn.dataset.queue = q; // –ß—Ç–æ–±—ã –ø–æ—Ç–æ–º –Ω–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É
                container.appendChild(btn);
            });
        }

        function selectQueue(q) {
            activeQueue = q;
            localStorage.setItem('myQueue', q);

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.queue-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === q);
            });

            document.getElementById('hero-card').style.display = 'block';
            document.getElementById('timeline-area').style.display = 'block';
            
            drawGraph();
            updateRealtimeStatus();
        }

        // --- 4. –†–∏—Å–æ–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ ---
        function drawGraph() {
            const container = document.getElementById('visual-schedule');
            container.innerHTML = '';
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –æ—Ç–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏
            const outages = activeSchedule.queues[activeQueue] || [];
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –∏–∑ 1440 –º–∏–Ω—É—Ç (24 —á–∞—Å–∞ * 60 –º–∏–Ω)
            // true = —Å–≤–µ—Ç –µ—Å—Ç—å, false = —Å–≤–µ—Ç–∞ –Ω–µ—Ç
            let dayMap = new Array(1440).fill(true);

            outages.forEach(interval => {
                const startMins = timeToMins(interval.start);
                let endMins = timeToMins(interval.end);
                if (endMins === 0) endMins = 1440; // 24:00

                for (let i = startMins; i < endMins; i++) {
                    if(i < 1440) dayMap[i] = false;
                }
            });

            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ (–æ–±—ä–µ–¥–∏–Ω—è–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –±–ª–æ–∫–∏)
            // –ß—Ç–æ–±—ã –Ω–µ —Ä–∏—Å–æ–≤–∞—Ç—å 1440 div-–æ–≤, —Ä–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            let currentStatus = dayMap[0];
            let blockStart = 0;

            for (let i = 1; i <= 1440; i++) {
                if (i === 1440 || dayMap[i] !== currentStatus) {
                    // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫
                    const widthPercent = ((i - blockStart) / 1440) * 100;
                    const div = document.createElement('div');
                    div.className = 'hour-block ' + (currentStatus ? 'bg-on' : 'bg-off');
                    div.style.flexBasis = widthPercent + '%';
                    container.appendChild(div);

                    currentStatus = dayMap[i];
                    blockStart = i;
                }
            }
        }

        // --- 5. –õ–æ–≥–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞ (–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ) ---
        function updateRealtimeStatus() {
            if (!activeQueue || !activeSchedule) return;

            const now = new Date();
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–Ω—è (0 - 1439)
            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Å–µ–≥–æ–¥–Ω—è, –ª–æ–≥–∏–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–æ–∂–Ω–µ–µ,
            // –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ—Ç—Ä–∏—Ç –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.
            const currentMins = (now.getHours() * 60) + now.getMinutes();
            
            // –î–≤–∏–≥–∞–µ–º –º–∞—Ä–∫–µ—Ä –≤—Ä–µ–º–µ–Ω–∏ (–∫—Ä–∞—Å–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞)
            const markerPercent = (currentMins / 1440) * 100;
            document.getElementById('time-marker').style.left = markerPercent + '%';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–≤–µ—Ç–∞
            // –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–∞—Ä—Ç—É –¥–Ω—è, —Ç–∞–∫ –∫–∞–∫ activeSchedule –º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±—ã–º
            const outages = activeSchedule.queues[activeQueue] || [];
            let isLightOn = true;
            let nextChangeMins = -1; // –ö–æ–≥–¥–∞ —Å–ª–µ–¥—É—é—â–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            let nextEventIsOn = false; // –ö–∞–∫–æ–µ —ç—Ç–æ –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ (–≤–∫–ª –∏–ª–∏ –≤—ã–∫–ª)

            // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ "—Å–µ–π—á–∞—Å" –≤ –∫–∞–∫–æ–π-—Ç–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
            // –ò –ø–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–≥–æ —Å–æ–±—ã—Ç–∏—è
            
            // –°–æ–±–µ—Ä–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π (00:00, –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü—ã –æ—Ç–∫–ª—é—á–µ–Ω–∏–π, 24:00)
            let changePoints = [0, 1440];
            outages.forEach(o => {
                changePoints.push(timeToMins(o.start));
                let end = timeToMins(o.end);
                if(end === 0) end = 1440;
                changePoints.push(end);
            });
            changePoints = [...new Set(changePoints)].sort((a,b) => a-b); // –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            for (let out of outages) {
                let s = timeToMins(out.start);
                let e = timeToMins(out.end);
                if (e === 0) e = 1440;
                
                if (currentMins >= s && currentMins < e) {
                    isLightOn = false;
                    break;
                }
            }

            // –ò—â–µ–º –°–õ–ï–î–£–Æ–©–£–Æ —Ç–æ—á–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏—è
            for (let point of changePoints) {
                if (point > currentMins) {
                    nextChangeMins = point;
                    break;
                }
            }

            if (nextChangeMins === -1) {
                nextChangeMins = 1440; // –ö–æ–Ω–µ—Ü –¥–Ω—è
            }

            // –†–µ–Ω–¥–µ—Ä UI
            const body = document.body;
            const icon = document.getElementById('status-icon');
            const title = document.getElementById('status-text');
            const countdown = document.getElementById('countdown-text');

            // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –¥–æ —Å–æ–±—ã—Ç–∏—è
            const diffMins = nextChangeMins - currentMins;
            const h = Math.floor(diffMins / 60);
            const m = diffMins % 60;
            const timeString = `${h} –≥–æ–¥ ${m} —Ö–≤`;

            if (isLightOn) {
                // –°–í–ï–¢ –ï–°–¢–¨
                body.classList.remove('dark-mode');
                icon.innerText = '‚òÄÔ∏è';
                title.innerText = '–°–í–Ü–¢–õ–û –Ñ';
                title.style.color = '#333'; // –¢–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å–≤–µ—Ç–ª–æ–º —Ñ–æ–Ω–µ
                countdown.innerText = `–í–∏–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑: ${timeString}`;
            } else {
                // –°–í–ï–¢–ê –ù–ï–¢
                body.classList.add('dark-mode');
                icon.innerText = 'üïØÔ∏è'; // –ò–ª–∏ üåë
                title.innerText = '–í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø';
                title.style.color = '#ff5e62';
                countdown.innerText = `–í–≤—ñ–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑: ${timeString}`;
            }
        }

        // –•–µ–ª–ø–µ—Ä: "14:30" -> 870 –º–∏–Ω—É—Ç
        function timeToMins(timeStr) {
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }

        init();
    </script>
</body>
</html>
