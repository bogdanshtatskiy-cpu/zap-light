<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–≤—ñ—Ç–ª–æ –ó–∞–ø–æ—Ä—ñ–∂–∂—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f8ff;
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.85);
            --accent-color: #4facfe;
            --status-bg: #e6f7ff;
            --shadow: 0 8px 20px rgba(0,0,0,0.08);
            --on-color: #4cd964;
            --off-color: #ff3b30;
            --card-border: rgba(255,255,255,0.4);
        }

        body.dark-mode {
            --bg-color: #121212;
            --text-color: #ffffff;
            --card-bg: rgba(30, 30, 30, 0.85);
            --accent-color: #ff9500;
            --status-bg: #2c2c2c;
            --shadow: 0 8px 20px rgba(0,0,0,0.4);
            --card-border: rgba(255,255,255,0.1);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 16px;
            transition: background-color 0.5s ease, color 0.5s ease;
            min-height: 100vh;
            box-sizing: border-box;
            user-select: none;
            overflow-x: hidden;
        }

        .background-blob {
            position: fixed;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, var(--accent-color) 0%, transparent 60%);
            opacity: 0.1; z-index: -1;
            transition: background 0.5s ease;
        }

        /* HEADER & LANG */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .lang-switch {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 4px;
            display: flex;
            box-shadow: var(--shadow);
            border: 1px solid var(--card-border);
        }

        .lang-btn {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
            color: var(--text-color);
            opacity: 0.6;
        }

        .lang-btn.active {
            background: var(--text-color);
            color: var(--bg-color);
            opacity: 1;
        }

        .date-tabs {
            display: flex;
            gap: 8px;
            flex-grow: 1;
            justify-content: center;
            margin-right: 10px;
        }
        .date-tab {
            background: transparent;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0.7;
            cursor: pointer;
            white-space: nowrap;
            transition: 0.2s;
        }
        .date-tab.active {
            background: var(--text-color);
            color: var(--bg-color);
            opacity: 1;
            font-weight: 800;
            transform: scale(1.05);
        }

        /* –û–ß–ï–†–ï–î–ò (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–∏—è) */
        .queue-container-wrapper {
            margin: 0 -16px 20px -16px; /* –í—ã—Ö–æ–¥ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –ø–∞–¥–¥–∏–Ω–≥–∞ body */
            padding: 0 16px;
        }
        
        .queue-selector {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 5px 15px 5px; /* –ù–∏–∂–Ω–∏–π –ø–∞–¥–¥–∏–Ω–≥ –¥–ª—è —Ç–µ–Ω–∏ */
            scrollbar-width: none; 
        }
        .queue-selector::-webkit-scrollbar { display: none; }

        .queue-btn {
            flex: 0 0 auto; /* –ù–µ —Å–∂–∏–º–∞—Ç—å */
            background: var(--card-bg);
            color: var(--text-color);
            padding: 12px 18px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 15px;
            cursor: pointer;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .queue-btn.active {
            border-color: var(--accent-color);
            background: var(--card-bg);
            transform: scale(1.1);
            z-index: 2;
        }

        /* STATUS CARD */
        .hero-card {
            background: var(--card-bg);
            border-radius: 28px;
            padding: 30px 20px;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            transition: 0.3s;
        }
        .status-icon { font-size: 64px; display: block; animation: float 3s ease-in-out infinite; margin-bottom: 10px; }
        .status-title { font-size: 28px; font-weight: 900; margin: 0; line-height: 1.1; letter-spacing: -0.5px; }
        .countdown { 
            font-size: 18px; 
            margin-top: 12px; 
            font-weight: 700; 
            font-variant-numeric: tabular-nums; /* –ß—Ç–æ–±—ã —Ü–∏—Ñ—Ä—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–∏ */
            opacity: 0.9;
        }
        .update-info { font-size: 11px; margin-top: 15px; opacity: 0.4; font-weight: 600; }

        /* TIMELINE */
        .timeline-container { position: relative; padding-top: 10px; margin-bottom: 25px; }
        .timeline-bar {
            display: flex;
            height: 44px;
            border-radius: 14px;
            overflow: hidden;
            border: 2px solid var(--card-bg);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .hour-block { flex: 1; height: 100%; position: relative; }
        
        /* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
        .bg-on { background: linear-gradient(180deg, #4cd964 0%, #34a849 100%); }
        .bg-off { background: linear-gradient(180deg, #ff3b30 0%, #d6271c 100%); }

        .current-time-marker {
            position: absolute;
            top: 4px; bottom: -6px; width: 4px;
            background: var(--text-color);
            border-radius: 4px;
            z-index: 10;
            box-shadow: 0 0 10px var(--text-color);
            transition: left 1s linear;
        }
        .current-time-marker::after {
            content: ''; position: absolute; top: -4px; left: -3px;
            width: 10px; height: 10px; background: var(--text-color);
            border-radius: 50%;
        }

        .time-labels {
            display: flex; justify-content: space-between;
            font-size: 11px; opacity: 0.6; margin-top: 8px; font-weight: 700;
            padding: 0 2px;
        }

        /* –°–¢–ê–¢–ò–°–¢–ò–ö–ê (2 —Å—Ç–æ–ª–±–∏–∫–∞) */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-box {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow);
        }
        .stat-label { font-size: 12px; opacity: 0.7; font-weight: 700; margin-bottom: 5px; display: block; }
        .stat-value { font-size: 20px; font-weight: 900; }
        
        .stat-box.on .stat-value { color: var(--on-color); text-shadow: 0 0 10px rgba(76, 217, 100, 0.3); }
        .stat-box.off .stat-value { color: var(--off-color); text-shadow: 0 0 10px rgba(255, 59, 48, 0.3); }

        .loading { text-align: center; padding: 60px; opacity: 0.6; font-weight: 700; }
        
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    </style>
</head>
<body>

    <div class="background-blob"></div>

    <div class="top-bar">
        <div class="date-tabs" id="date-tabs"></div>
        
        <div class="lang-switch">
            <div class="lang-btn active" onclick="setLanguage('uk')" id="btn-uk">UA</div>
            <div class="lang-btn" onclick="setLanguage('ru')" id="btn-ru">RU</div>
        </div>
    </div>

    <div class="queue-container-wrapper">
        <div class="queue-selector" id="queue-container"></div>
    </div>

    <div class="hero-card" id="hero-card" style="display:none;">
        <div class="status-icon" id="status-icon">‚ö°</div>
        <div class="status-title" id="status-text">...</div>
        <div class="countdown" id="countdown-text">...</div>
        <div class="update-info" id="update-time"></div>
    </div>

    <div class="timeline-container" id="timeline-area" style="display:none;">
        <div class="timeline-bar" id="visual-schedule"></div>
        <div class="current-time-marker" id="time-marker"></div>
        <div class="time-labels">
            <span>00</span><span>04</span><span>08</span><span>12</span><span>16</span><span>20</span><span>24</span>
        </div>
    </div>

    <div class="stats-grid" id="stats-area" style="display:none;">
        <div class="stat-box on">
            <span class="stat-label" id="label-on">–°–≤—ñ—Ç–ª–æ —î</span>
            <div class="stat-value" id="val-on">0 –≥–æ–¥</div>
        </div>
        <div class="stat-box off">
            <span class="stat-label" id="label-off">–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞</span>
            <div class="stat-value" id="val-off">0 –≥–æ–¥</div>
        </div>
    </div>

    <div class="loading" id="loading">...</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const translations = {
            uk: {
                loading: "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...",
                no_data: "–ì—Ä–∞—Ñ—ñ–∫—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î ü§∑‚Äç‚ôÇÔ∏è",
                select_queue: "–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É",
                light_on: "–°–í–Ü–¢–õ–û –Ñ",
                light_off: "–°–í–Ü–¢–õ–ê –ù–ï–ú–ê",
                until_off: "–í–∏–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑:",
                until_on: "–í–≤—ñ–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑:",
                updated: "–û–Ω–æ–≤–ª–µ–Ω–æ:",
                label_on: "–°–≤—ñ—Ç–ª–æ —î (—Ä–∞–∑–æ–º)",
                label_off: "–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞ (—Ä–∞–∑–æ–º)",
                hr: "–≥–æ–¥",
                min: "—Ö–≤",
                sec: "—Å"
            },
            ru: {
                loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
                no_data: "–ì—Ä–∞—Ñ–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç ü§∑‚Äç‚ôÇÔ∏è",
                select_queue: "–í—ã–±–µ—Ä–∏—Ç–µ –æ—á–µ—Ä–µ–¥—å",
                light_on: "–°–í–ï–¢ –ï–°–¢–¨",
                light_off: "–°–í–ï–¢–ê –ù–ï–¢",
                until_off: "–û—Ç–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑:",
                until_on: "–í–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑:",
                updated: "–û–±–Ω–æ–≤–ª–µ–Ω–æ:",
                label_on: "–°–≤–µ—Ç –µ—Å—Ç—å (–≤—Å–µ–≥–æ)",
                label_off: "–°–≤–µ—Ç–∞ –Ω–µ—Ç (–≤—Å–µ–≥–æ)",
                hr: "—á",
                min: "–º–∏–Ω",
                sec: "—Å"
            }
        };

        const monthMapping = {
            "–°–Ü–ß–ù–Ø": "–Ø–ù–í–ê–†–Ø", "–õ–Æ–¢–û–ì–û": "–§–ï–í–†–ê–õ–Ø", "–ë–ï–†–ï–ó–ù–Ø": "–ú–ê–†–¢–ê",
            "–ö–í–Ü–¢–ù–Ø": "–ê–ü–†–ï–õ–Ø", "–¢–†–ê–í–ù–Ø": "–ú–ê–Ø", "–ß–ï–†–í–ù–Ø": "–ò–Æ–ù–Ø",
            "–õ–ò–ü–ù–Ø": "–ò–Æ–õ–Ø", "–°–ï–†–ü–ù–Ø": "–ê–í–ì–£–°–¢–ê", "–í–ï–†–ï–°–ù–Ø": "–°–ï–ù–¢–Ø–ë–†–Ø",
            "–ñ–û–í–¢–ù–Ø": "–û–ö–¢–Ø–ë–†–Ø", "–õ–ò–°–¢–û–ü–ê–î–ê": "–ù–û–Ø–ë–†–Ø", "–ì–†–£–î–ù–Ø": "–î–ï–ö–ê–ë–†–Ø"
        };

        let currentLang = localStorage.getItem('appLang') || 'uk';
        let schedulesData = [];
        let activeSchedule = null;
        let activeQueue = localStorage.getItem('myQueue');

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('appLang', lang);
            
            document.getElementById('btn-uk').classList.toggle('active', lang === 'uk');
            document.getElementById('btn-ru').classList.toggle('active', lang === 'ru');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –ª–µ–π–±–ª—ã
            document.getElementById('label-on').innerText = translations[lang].label_on;
            document.getElementById('label-off').innerText = translations[lang].label_off;

            if (schedulesData.length > 0) {
                renderDateTabs();
                const currentIdx = schedulesData.indexOf(activeSchedule);
                selectSchedule(currentIdx !== -1 ? currentIdx : 0);
                
                if (!activeQueue) {
                    document.getElementById('status-text').innerText = translations[lang].select_queue;
                } else {
                    updateStats(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (—á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª–∏—Å—å "–≥–æ–¥/–º–∏–Ω")
                }
            } else {
                document.getElementById('loading').innerText = translations[lang].loading;
            }
        }

        function translateDate(dateStr) {
            if (currentLang === 'uk') return dateStr;
            let newStr = dateStr;
            for (const [ua, ru] of Object.entries(monthMapping)) {
                if (newStr.includes(ua)) {
                    newStr = newStr.replace(ua, ru);
                    break;
                }
            }
            return newStr;
        }

        async function init() {
            setLanguage(currentLang);
            try {
                const resp = await fetch('schedule.json?v=' + Date.now());
                const json = await resp.json();
                schedulesData = json.schedules;
                
                document.getElementById('loading').style.display = 'none';

                if (!schedulesData || schedulesData.length === 0) {
                    document.getElementById('loading').innerText = translations[currentLang].no_data;
                    document.getElementById('loading').style.display = 'block';
                    return;
                }

                renderDateTabs();
                selectSchedule(0);
                renderQueueButtons();

                if (activeQueue) {
                    selectQueue(activeQueue);
                } else {
                    document.getElementById('hero-card').style.display = 'block';
                    document.getElementById('status-icon').innerText = 'üëÜ';
                    document.getElementById('status-text').innerText = translations[currentLang].select_queue;
                }

                setInterval(updateRealtimeStatus, 1000);

            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerText = "Error loading data";
            }
        }

        function renderDateTabs() {
            const container = document.getElementById('date-tabs');
            container.innerHTML = '';
            schedulesData.forEach((sch, idx) => {
                const btn = document.createElement('div');
                btn.className = `date-tab ${activeSchedule === sch ? 'active' : ''}`;
                btn.innerText = translateDate(sch.date);
                btn.onclick = () => selectSchedule(idx);
                container.appendChild(btn);
            });
        }

        function selectSchedule(idx) {
            activeSchedule = schedulesData[idx];
            renderDateTabs();
            document.getElementById('update-time').innerText = 
                `${translations[currentLang].updated} ${activeSchedule.updated_at}`;

            if (activeQueue) {
                drawGraph();
                updateStats();
                updateRealtimeStatus();
            }
        }

        function renderQueueButtons() {
            const container = document.getElementById('queue-container');
            const queues = ["1.1", "1.2", "2.1", "2.2", "3.1", "3.2", "4.1", "4.2", "5.1", "5.2", "6.1", "6.2"];
            container.innerHTML = '';
            queues.forEach(q => {
                const btn = document.createElement('div');
                btn.className = `queue-btn ${activeQueue === q ? 'active' : ''}`;
                btn.innerText = q;
                btn.onclick = () => selectQueue(q);
                container.appendChild(btn);
            });
        }

        function selectQueue(q) {
            activeQueue = q;
            localStorage.setItem('myQueue', q);
            renderQueueButtons();

            document.getElementById('hero-card').style.display = 'block';
            document.getElementById('timeline-area').style.display = 'block';
            document.getElementById('stats-area').style.display = 'grid'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            
            drawGraph();
            updateStats();
            updateRealtimeStatus();
        }

        function drawGraph() {
            const container = document.getElementById('visual-schedule');
            container.innerHTML = '';
            const outages = activeSchedule.queues[activeQueue] || [];
            let dayMap = new Array(1440).fill(true);

            outages.forEach(interval => {
                const start = timeToMins(interval.start);
                let end = timeToMins(interval.end);
                if (end === 0) end = 1440;
                for (let i = start; i < end; i++) if(i < 1440) dayMap[i] = false;
            });

            let currentStatus = dayMap[0];
            let blockStart = 0;
            for (let i = 1; i <= 1440; i++) {
                if (i === 1440 || dayMap[i] !== currentStatus) {
                    const width = ((i - blockStart) / 1440) * 100;
                    const div = document.createElement('div');
                    div.className = 'hour-block ' + (currentStatus ? 'bg-on' : 'bg-off');
                    div.style.flexBasis = width + '%';
                    container.appendChild(div);
                    currentStatus = dayMap[i];
                    blockStart = i;
                }
            }
        }

        // –ü–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –Ω–µ—Ç —Å–≤–µ—Ç–∞ –∑–∞ –¥–µ–Ω—å)
        function updateStats() {
            const outages = activeSchedule.queues[activeQueue] || [];
            let totalOffMinutes = 0;

            outages.forEach(interval => {
                const start = timeToMins(interval.start);
                let end = timeToMins(interval.end);
                if (end === 0) end = 1440;
                totalOffMinutes += (end - start);
            });

            const totalOnMinutes = 1440 - totalOffMinutes;
            const t = translations[currentLang];

            document.getElementById('val-off').innerText = formatDuration(totalOffMinutes, t);
            document.getElementById('val-on').innerText = formatDuration(totalOnMinutes, t);
        }

        function formatDuration(minutes, t) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            if (h > 0 && m > 0) return `${h}${t.hr} ${m}${t.min}`;
            if (h > 0) return `${h} ${t.hr}`;
            return `${m} ${t.min}`;
        }

        function updateRealtimeStatus() {
            if (!activeQueue || !activeSchedule) return;

            const t = translations[currentLang];
            const now = new Date();
            const currentMins = (now.getHours() * 60) + now.getMinutes();
            const currentSecondsTotal = currentMins * 60 + now.getSeconds();
            
            // –î–≤–∏–≥–∞–µ–º –º–∞—Ä–∫–µ—Ä
            document.getElementById('time-marker').style.left = (currentMins / 1440) * 100 + '%';

            const outages = activeSchedule.queues[activeQueue] || [];
            let isLightOn = true;
            let nextChangeMin = 1440;

            let points = [0, 1440];
            outages.forEach(o => {
                let s = timeToMins(o.start);
                let e = timeToMins(o.end);
                if(e === 0) e = 1440;
                points.push(s, e);
                
                if (currentMins >= s && currentMins < e) isLightOn = false;
            });
            
            points = [...new Set(points)].sort((a,b) => a-b);
            for(let p of points) {
                if(p > currentMins) { nextChangeMin = p; break; }
            }

            // –¢–∞–π–º–µ—Ä —Å —Å–µ–∫—É–Ω–¥–∞–º–∏
            // nextChangeMin - —ç—Ç–æ –º–∏–Ω—É—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 14:00 = 840 –º–∏–Ω)
            // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Å–µ–∫—É–Ω–¥—ã –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–Ω—è
            const targetSeconds = nextChangeMin * 60;
            let diffSec = targetSeconds - currentSecondsTotal;
            
            if (diffSec < 0) diffSec = 0;

            const h = Math.floor(diffSec / 3600);
            const m = Math.floor((diffSec % 3600) / 60);
            const s = diffSec % 60;
            
            // –ö—Ä–∞—Å–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ 00:00:00
            const pad = (n) => n.toString().padStart(2, '0');
            const timeStr = `${pad(h)}:${pad(m)}:${pad(s)}`;

            const icon = document.getElementById('status-icon');
            const title = document.getElementById('status-text');
            const count = document.getElementById('countdown-text');

            if (isLightOn) {
                document.body.classList.remove('dark-mode');
                icon.innerText = '‚òÄÔ∏è';
                title.innerText = t.light_on;
                title.style.color = '#333';
                count.innerText = `${t.until_off} ${timeStr}`;
            } else {
                document.body.classList.add('dark-mode');
                icon.innerText = 'üïØÔ∏è';
                title.innerText = t.light_off;
                title.style.color = '#ff5e62';
                count.innerText = `${t.until_on} ${timeStr}`;
            }
        }

        function timeToMins(s) {
            const p = s.split(':');
            return parseInt(p[0]) * 60 + parseInt(p[1]);
        }

        init();
    </script>
</body>
</html>
