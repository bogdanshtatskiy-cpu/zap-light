<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ—ñ–∫ –°–≤—ñ—Ç–ª–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --accent: #4facfe;
            --off-color: #ff5e62; /* –ö—Ä–∞—Å–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            --on-color: #00b09b;  /* –ó–µ–ª–µ–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
        }
        
        body {
            background: var(--bg-gradient);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* –¢–∞–±—ã –¥–ª—è –¥–∞—Ç */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .tab-btn {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 20px;
            white-space: nowrap;
            cursor: pointer;
            transition: 0.3s;
            font-size: 14px;
        }
        
        .tab-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ç–µ */
        .header-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .header-info h2 { margin: 0; font-size: 22px; font-weight: 700; }
        .header-info p { margin: 5px 0 0; color: var(--text-secondary); font-size: 13px; }

        /* –°–µ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–µ–π */
        .queue-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 –≤ —Ä—è–¥ */
            gap: 8px;
            margin-bottom: 25px;
        }

        .queue-chip {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            padding: 12px 0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .queue-chip.active {
            background: white;
            color: #203a43;
            font-weight: bold;
            transform: scale(1.05);
        }

        /* –ì—Ä–∞—Ñ–∏–∫ */
        .timeline-wrapper {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeline-bar {
            display: flex;
            height: 40px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .block {
            flex: 1;
            height: 100%;
            background: var(--on-color);
            position: relative;
        }
        
        .block.off {
            background: var(--off-color);
        }
        
        /* –®–∫–∞–ª–∞ –≤—Ä–µ–º–µ–Ω–∏ */
        .time-scale {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .status-badge {
            margin-top: 15px;
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            font-size: 14px;
        }

        .loading { text-align: center; margin-top: 50px; color: var(--text-secondary); }
    </style>
</head>
<body>

    <div class="tabs" id="date-tabs">
        </div>

    <div class="header-info" id="header-info" style="display:none;">
        <h2 id="date-title">...</h2>
        <p id="update-time"></p>
    </div>

    <div class="queue-grid" id="queue-grid">
        </div>

    <div class="timeline-wrapper" id="timeline-card" style="display:none;">
        <div class="timeline-bar" id="visual-schedule"></div>
        <div class="time-scale">
            <span>00:00</span><span>06:00</span><span>12:00</span><span>18:00</span><span>24:00</span>
        </div>
        <div class="status-badge" id="current-status">
            –û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É –∑–≤–µ—Ä—Ö—É
        </div>
    </div>

    <div class="loading" id="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let allSchedules = [];
        let currentSchedule = null;
        const queues = ["1.1", "1.2", "2.1", "2.2", "3.1", "3.2", "4.1", "4.2", "5.1", "5.2", "6.1", "6.2"];

        async function init() {
            try {
                const response = await fetch('schedule.json?v=' + Date.now()); // anti-cache
                const data = await response.json();
                
                allSchedules = data.schedules;
                document.getElementById('loading').style.display = 'none';

                if (allSchedules.length === 0) {
                    document.getElementById('loading').innerText = "–ì—Ä–∞—Ñ—ñ–∫—ñ–≤ –Ω–∞ —Å–∞–π—Ç—ñ –ø–æ–∫–∏ –Ω–µ–º–∞—î";
                    document.getElementById('loading').style.display = 'block';
                    return;
                }

                renderTabs();
                renderQueueButtons();
                
                // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                selectDate(0);
                
                // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±–æ—Ä –æ—á–µ—Ä–µ–¥–∏
                const savedQ = localStorage.getItem('selectedQueue');
                if (savedQ) selectQueue(savedQ);

            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerText = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è";
            }
        }

        function renderTabs() {
            const container = document.getElementById('date-tabs');
            container.innerHTML = '';
            
            allSchedules.forEach((sch, index) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.innerText = sch.date;
                btn.onclick = () => selectDate(index);
                btn.id = `tab-${index}`;
                container.appendChild(btn);
            });
        }

        function selectDate(index) {
            currentSchedule = allSchedules[index];
            
            // UI –¢–∞–±–æ–≤
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${index}`).classList.add('active');

            // –ò–Ω—Ñ–æ
            document.getElementById('header-info').style.display = 'block';
            document.getElementById('date-title').innerText = currentSchedule.date;
            document.getElementById('update-time').innerText = currentSchedule.updated_at 
                ? `–û–Ω–æ–≤–ª–µ–Ω–æ: ${currentSchedule.updated_at}` 
                : "–û—Å–Ω–æ–≤–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫";

            // –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            const activeQueue = document.querySelector('.queue-chip.active');
            if (activeQueue) {
                drawSchedule(activeQueue.innerText); // innerText —ç—Ç–æ '1.1' –∏ —Ç.–¥.
            }
        }

        function renderQueueButtons() {
            const container = document.getElementById('queue-grid');
            queues.forEach(q => {
                const btn = document.createElement('div');
                btn.className = 'queue-chip';
                btn.innerText = q;
                btn.onclick = () => selectQueue(q);
                btn.id = `q-${q.replace('.', '-')}`;
                container.appendChild(btn);
            });
        }

        function selectQueue(queueId) {
            // UI –ö–Ω–æ–ø–æ–∫
            document.querySelectorAll('.queue-chip').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`q-${queueId.replace('.', '-')}`);
            if(btn) btn.classList.add('active');

            localStorage.setItem('selectedQueue', queueId);
            document.getElementById('timeline-card').style.display = 'block';
            
            drawSchedule(queueId);
        }

        function drawSchedule(queueId) {
            const intervals = currentSchedule.queues[queueId] || [];
            const container = document.getElementById('visual-schedule');
            container.innerHTML = '';
            
            // 48 –±–ª–æ–∫–æ–≤ –ø–æ 30 –º–∏–Ω—É—Ç
            const totalBlocks = 48;
            let map = new Array(totalBlocks).fill(true); // true = —Å–≤–µ—Ç –µ—Å—Ç—å

            intervals.forEach(inv => {
                const [sH, sM] = inv.start.split(':').map(Number);
                const [eH, eM] = inv.end.split(':').map(Number);
                
                let startIdx = (sH * 2) + (sM >= 30 ? 1 : 0);
                let endIdx = (eH * 2) + (eM >= 30 ? 1 : 0);
                if (endIdx === 0) endIdx = 48; // –∫–æ–Ω–µ—Ü —Å—É—Ç–æ–∫

                for(let i = startIdx; i < endIdx; i++) {
                    if(i < 48) map[i] = false;
                }
            });

            // –†–µ–Ω–¥–µ—Ä
            map.forEach(hasLight => {
                const div = document.createElement('div');
                div.className = 'block ' + (hasLight ? '' : 'off');
                container.appendChild(div);
            });

            updateStatusText(map);
        }

        function updateStatusText(map) {
            const now = new Date();
            // –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –±–ª–æ–∫–∞ (—É—á–∏—Ç—ã–≤–∞—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –£–∫—Ä–∞–∏–Ω–µ)
            const idx = (now.getHours() * 2) + (now.getMinutes() >= 30 ? 1 : 0);
            const hasLight = map[idx];
            
            const badge = document.getElementById('current-status');
            if (hasLight) {
                badge.innerHTML = "–ó–∞—Ä–∞–∑: <span style='color:#4facfe; font-weight:bold'>–°–í–Ü–¢–õ–û –Ñ ‚ö°</span>";
            } else {
                badge.innerHTML = "–ó–∞—Ä–∞–∑: <span style='color:#ff5e62; font-weight:bold'>–í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø üïØÔ∏è</span>";
            }
        }

        init();
    </script>
</body>
</html>
